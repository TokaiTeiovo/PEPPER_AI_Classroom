<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>智能教学系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2f3542;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            color: #2f3542;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .nav-tab {
            flex: 1;
            padding: 20px 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 4px solid transparent;
            transition: all 0.3s ease;
            color: #57606f;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-color: #ffffff;
        }

        .nav-tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }

        .panel h2 {
            color: #2f3542;
            margin-bottom: 25px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #57606f;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #a4b0be;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #57606f, #6c7a89);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ed573, #17d0aa);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #ff6b7a);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-online {
            background: linear-gradient(135deg, #2ed573, #17d0aa);
            color: white;
        }

        .status-offline {
            background: linear-gradient(135deg, #ff4757, #ff6b7a);
            color: white;
        }

        .quantization-options {
            margin-bottom: 20px;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-option {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .radio-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .radio-option input[type="radio"] {
            margin-right: 12px;
            margin-top: 2px;
            width: auto;
        }

        .radio-option:has(input:checked) {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .radio-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .radio-label strong {
            font-size: 15px;
            color: #2f3542;
        }

        .radio-label small {
            color: #666;
            font-size: 12px;
        }

        .file-upload {
            border: 3px dashed #e1e5e9;
            border-radius: 12px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.5);
        }

        .file-upload:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e1e5e9;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            border-radius: 15px;
        }

        .progress-container {
            position: relative;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 13px;
            color: #666;
        }

        .model-selector-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .model-select {
            flex: 1;
        }

        .btn-scan {
            padding: 15px 20px;
            white-space: nowrap;
        }

        .scan-status {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            font-size: 13px;
            border-left: 4px solid #667eea;
        }

        .chat-container {
            height: 400px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(248, 249, 255, 0.8);
            backdrop-filter: blur(5px);
        }

        .chat-message {
            margin-bottom: 18px;
            padding: 15px;
            border-radius: 15px;
            max-width: 85%;
            word-wrap: break-word;
        }

        .chat-user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .chat-assistant {
            background: white;
            border: 1px solid #e1e5e9;
            color: #2f3542;
            border-bottom-left-radius: 5px;
        }

        .log-container {
            background: #2f3542;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 20px;
            border-radius: 12px;
            height: 250px;
            overflow-y: auto;
        }

        #quantization-info, #training-details {
            border-left: 4px solid #667eea;
            background: rgba(102, 126, 234, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .grid-2, .form-row {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .model-selector-container {
                flex-direction: column;
            }

            .btn-scan {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 智能教学系统</h1>
            <p>基于DeepSeek-LoRA微调与Neo4j知识图谱的多模态智能教育平台</p>
        </div>

        <!-- 导航标签 -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('training')">🧠 LoRA模型训练</button>
            <button class="nav-tab" onclick="showTab('chat')">💬 智能问答系统</button>
        </div>

        <!-- LoRA训练标签页 -->
        <div id="training" class="tab-content active">
            <div class="grid-2">
                <div class="panel">
                    <h2>📁 模型选择与管理</h2>

                    <!-- 模型发现和选择 -->
                    <div class="form-group">
                        <label>选择基础模型</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="model-mode" value="auto" checked onchange="toggleModelMode()" style="margin-right: 8px;">
                                <span>🎯 自动发现</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="model-mode" value="manual" onchange="toggleModelMode()" style="margin-right: 8px;">
                                <span>✏️ 手动输入</span>
                            </label>
                        </div>

                        <!-- 自动发现模式 -->
                        <div id="auto-model-section">
                            <div class="model-selector-container">
                                <select id="model-selector" class="model-select">
                                    <option value="">🔍 选择一个模型...</option>
                                </select>
                                <button class="btn-scan" onclick="discoverModels()">
                                    <span>🔄 扫描模型</span>
                                </button>
                            </div>
                            <div id="model-scan-status" class="scan-status">
                                点击"扫描模型"来发现可用的模型
                            </div>
                        </div>

                        <!-- 手动输入模式 -->
                        <div id="manual-model-section" style="display: none;">
                            <input type="text" id="model-path"
                                   value="models/deepseek-coder-1.3b-base"
                                   placeholder="输入模型路径，例如：models/deepseek-coder-1.3b-base">
                        </div>
                    </div>

                    <!-- 模型详细信息展示 -->
                    <div id="model-details" style="display: none; background: rgba(248, 249, 255, 0.8); padding: 20px; border-radius: 12px; margin: 15px 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <strong>📊 模型信息</strong>
                                <ul id="model-basic-info" style="margin: 8px 0; padding-left: 20px;">
                                </ul>
                            </div>
                            <div>
                                <strong>📈 文件统计</strong>
                                <ul id="model-file-stats" style="margin: 8px 0; padding-left: 20px;">
                                </ul>
                            </div>
                        </div>
                    </div>

                    <h2>⚙️ 量化训练配置</h2>

                    <!-- 量化配置部分 -->
                    <div class="form-group">
                        <label>量化设置</label>
                        <div class="quantization-options">
                            <div id="quantization-info">
                                <div>🔍 正在检查量化支持...</div>
                            </div>

                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="quantization" value="4bit" checked>
                                    <span class="radio-label">
                                        <strong>4bit量化训练</strong>
                                        <small>最节省内存，适合低配置GPU（推荐）</small>
                                    </span>
                                </label>

                                <label class="radio-option">
                                    <input type="radio" name="quantization" value="8bit">
                                    <span class="radio-label">
                                        <strong>8bit量化训练</strong>
                                        <small>平衡性能和内存使用</small>
                                    </span>
                                </label>

                                <label class="radio-option">
                                    <input type="radio" name="quantization" value="full">
                                    <span class="radio-label">
                                        <strong>全精度训练</strong>
                                        <small>最高质量，需要大量GPU内存</small>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button onclick="checkQuantizationSupport()">🔍 检查量化支持</button>
                    </div>
                </div>

                <div class="panel">
                    <h2>🎯 LoRA训练参数</h2>

                    <div class="form-group">
                        <label>训练数据文件</label>
                        <div class="file-upload" onclick="document.getElementById('training-data').click()">
                            <input type="file" id="training-data" accept=".json,.csv" style="display: none;">
                            <p>点击上传训练数据</p>
                            <small>支持JSON/CSV格式</small>
                        </div>
                        <!-- 文件信息显示区域 -->
                        <div id="file-info" style="display: none; margin-top: 15px; padding: 15px; background: rgba(46, 213, 115, 0.1); border: 1px solid #2ed573; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: #2ed573; font-size: 16px;">✅</span>
                                <div>
                                    <div id="file-name" style="font-weight: 600; color: #2f3542;"></div>
                                    <div id="file-details" style="font-size: 13px; color: #666; margin-top: 4px;"></div>
                                </div>
                                <!-- 删除按钮 -->
                                <button id="remove-file-btn" type="button" onclick="removeUploadedFile(event)"
                                        style="background: linear-gradient(135deg, #ff4757, #ff6b7a); color: white; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 600; transition: all 0.3s ease; margin-left: 15px; box-shadow: 0 2px 8px rgba(255, 71, 87, 0.3);"
                                        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(255, 71, 87, 0.4)'"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(255, 71, 87, 0.3)'"
                                        title="删除文件">
                                    🗑️ 删除
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>训练轮数 (Epochs)</label>
                            <input type="number" id="epochs" value="3" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label>批次大小 (Batch Size)</label>
                            <input type="number" id="batch-size" value="2" min="1" max="8">
                            <small style="color: #666; font-size: 12px;">4bit量化推荐使用2</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>学习率 (Learning Rate)</label>
                            <input type="number" id="learning-rate" value="0.0002" step="0.0001">
                        </div>
                        <div class="form-group">
                            <label>预计训练时间</label>
                            <div id="estimated-time" style="padding: 12px; background: rgba(248, 249, 255, 0.8); border-radius: 8px; font-size: 13px;">
                                根据配置自动计算
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button onclick="startFineTuning()" id="start-training-btn">🚀 开始LoRA微调</button>
                        <!-- 在训练按钮附近添加 -->
                        <button onclick="manualCleanup()" class="btn-secondary">🗑️ 手动清理内存</button>
                    </div>

                    <div class="form-group">
                        <label>训练进度</label>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="training-progress" style="width: 0%"></div>
                            </div>
                            <div class="progress-info">
                                <span id="progress-text">0%</span>
                                <span id="progress-time"></span>
                            </div>
                        </div>

                        <!-- 详细训练信息 -->
                        <div id="training-details" style="display: none;">
                            <div><strong>量化方式:</strong> <span id="training-quantization">-</span></div>
                            <div><strong>批次大小:</strong> <span id="training-batch-size">-</span></div>
                            <div><strong>预计剩余:</strong> <span id="training-remaining">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 智能问答标签页 -->
        <div id="chat" class="tab-content">
            <div class="grid-2">
                <div class="panel">
                    <h2>🤖 模型加载管理</h2>

                    <div class="form-group">
                        <label>模型状态</label>
                        <div class="status-indicator status-offline" id="model-status">
                            ● 模型未加载
                        </div>
                    </div>

                    <div class="form-group">
                        <label>选择模型</label>
                        <select id="chat-model-selector">
                            <option value="">选择要加载的模型...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <button onclick="loadChatModel()" id="load-chat-model-btn">📥 加载模型</button>
                        <button class="btn-secondary" onclick="unloadChatModel()">📤 卸载模型</button>
                    </div>

                    <h2>🗄️ Neo4j知识图谱</h2>

                    <div class="form-group">
                        <label>数据库连接状态</label>
                        <div class="status-indicator status-offline" id="neo4j-status">
                            ● 数据库未连接
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>服务器地址</label>
                            <input type="text" id="neo4j-uri" value="bolt://localhost:7687">
                        </div>
                        <div class="form-group">
                            <label>用户名</label>
                            <input type="text" id="neo4j-user" value="neo4j">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>密码</label>
                        <input type="password" id="neo4j-password" value="adminadmin">
                    </div>

                    <div class="form-group">
                        <button onclick="connectNeo4j()">🔗 连接数据库</button>
                        <button class="btn-secondary" onclick="disconnectNeo4j()">❌断开连接</button>
                        <button class="btn-success" onclick="generateSampleKnowledge()">📚 生成示例知识</button>
                    </div>

                    <h2>⚙️ 模型参数</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Temperature</label>
                            <input type="range" id="temperature" min="0.1" max="2.0" step="0.1" value="0.7">
                            <span id="temp-value">0.7</span>
                        </div>
                        <div class="form-group">
                            <label>Max Tokens</label>
                            <input type="number" id="max-tokens" value="512" min="50" max="2048">
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2>💬 智能对话</h2>

                    <div class="chat-container" id="chat-messages">
                        <div class="chat-message chat-assistant">
                            <strong>🤖 智能教育系統:</strong> 你好！我是基于DeepSeek和Neo4j知识图谱的AI教学助手。请先加载模型和连接知识图谱，然后就可以开始对话了！
                        </div>
                    </div>

                    <div class="form-group" style="display: flex; gap: 10px; margin-top: 20px;">
                        <textarea id="chat-input" rows="3" placeholder="输入你的问题..." style="flex: 1; resize: vertical;"></textarea>
                        <button onclick="sendMessage()" style="width: 100px; height: fit-content;">💬 发送</button>
                    </div>

                    <div class="form-group">
                        <button onclick="clearChat()" class="btn-secondary">🗑️ 清空对话</button>
                        <button onclick="testModelConnection()" class="btn-success">🧪 测试连接</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系统日志 -->
        <div class="panel">
            <h2>📝 系统日志</h2>
            <div class="log-container" id="system-log">
                [系统] 智能教学系统已启动，等待操作...
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let modelLoaded = false;
        let neo4jConnected = false;
        let discoveredModels = [];
        let selectedModelInfo = null;
        let currentTrainingConfig = null;
        let trainingState = 'idle';

        // 标签页切换
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            logMessage('info', `切换到${getTabName(tabName)}页面`);
        }

        function getTabName(tabName) {
            const names = {
                'training': 'LoRA模型训练',
                'chat': '智能问答系统'
            };
            return names[tabName] || tabName;
        }

        // 日志记录
        function logMessage(level, message) {
            const logContainer = document.getElementById('system-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${level.toUpperCase()}] ${message}\n`;
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // API调用函数
        async function callAPI(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    if (data instanceof FormData) {
                        delete options.headers['Content-Type'];
                        options.body = data;
                    } else {
                        options.body = JSON.stringify(data);
                    }
                }

                const response = await fetch(`/api/${endpoint}`, options);
                return await response.json();
            } catch (error) {
                logMessage('error', `API调用失败: ${error.message}`);
                return { status: 'error', message: error.message };
            }
        }

        // ======= 第一页：LoRA训练相关函数 =======

        // 发现可用模型
        async function discoverModels() {
            const scanBtn = document.querySelector('.btn-scan');
            const scanStatus = document.getElementById('model-scan-status');

            scanBtn.textContent = '🔄 扫描中...';
            scanStatus.textContent = '🔍 正在扫描模型目录...';
            scanStatus.style.borderLeftColor = '#ff9f43';

            logMessage('info', '开始扫描模型目录');

            const result = await callAPI('discover_models');

            scanBtn.textContent = '🔄 扫描模型';

            if (result.status === 'success') {
                discoveredModels = result.models;
                updateModelSelector();
                updateChatModelSelector(); // 同时更新问答页面的模型选择器

                const validCount = result.models.filter(m => m.valid).length;
                scanStatus.innerHTML = `✅ 发现 <strong>${result.count}</strong> 个模型目录，其中 <strong>${validCount}</strong> 个有效`;
                scanStatus.style.borderLeftColor = '#2ed573';

                logMessage('info', `模型扫描完成，发现 ${result.count} 个模型目录`);
            } else {
                scanStatus.innerHTML = `❌ 扫描失败: ${result.message}`;
                scanStatus.style.borderLeftColor = '#ff4757';
                logMessage('error', `模型扫描失败: ${result.message}`);
            }
        }

        // 更新模型选择器
        function updateModelSelector() {
            const selector = document.getElementById('model-selector');
            selector.innerHTML = '<option value="">🎯 选择一个模型...</option>';

            if (discoveredModels.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '😔 未发现任何模型';
                option.disabled = true;
                selector.appendChild(option);
                return;
            }

            discoveredModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.path;

                if (model.valid) {
                    option.textContent = `${model.display_name}`;
                    option.style.color = '#2f3542';
                } else {
                    option.textContent = `${model.display_name} (⚠️ 不完整)`;
                    option.style.color = '#ff6b7a';
                    option.style.fontStyle = 'italic';
                }

                selector.appendChild(option);
            });

            selector.removeEventListener('change', onModelSelect);
            selector.addEventListener('change', onModelSelect);
        }

        // 更新问答页面的模型选择器
        function updateChatModelSelector() {
            const selector = document.getElementById('chat-model-selector');
            selector.innerHTML = '<option value="">选择要加载的模型...</option>';

            if (discoveredModels.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '😔 未发现任何模型';
                option.disabled = true;
                selector.appendChild(option);
                return;
            }

            discoveredModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.path;
                option.textContent = model.valid ? model.display_name : `${model.display_name} (⚠️ 不完整)`;
                selector.appendChild(option);
            });
        }

        // 模型选择事件处理
        async function onModelSelect(event) {
            const selectedPath = event.target.value;
            const pathInput = document.getElementById('model-path');
            const detailsDiv = document.getElementById('model-details');

            if (selectedPath) {
                pathInput.value = selectedPath;
                await loadModelDetails(selectedPath);
                detailsDiv.style.display = 'block';
                logMessage('info', `已选择模型: ${selectedPath}`);
            } else {
                detailsDiv.style.display = 'none';
                selectedModelInfo = null;
            }
        }

        // 加载模型详细信息
        async function loadModelDetails(modelPath) {
            const result = await callAPI('get_model_info', 'POST', { model_path: modelPath });

            if (result.status === 'success') {
                selectedModelInfo = result.model_info;
                displayModelDetails(selectedModelInfo);
            } else {
                logMessage('error', `获取模型信息失败: ${result.message}`);
            }
        }

        // 显示模型详细信息
        function displayModelDetails(modelInfo) {
            const basicInfo = document.getElementById('model-basic-info');
            basicInfo.innerHTML = `
                <li>名称: ${modelInfo.name}</li>
                <li>类型: ${modelInfo.model_type || '未知'}</li>
                <li>大小: ${modelInfo.total_size_display}</li>
                <li>词汇量: ${modelInfo.vocab_size ? modelInfo.vocab_size.toLocaleString() : '未知'}</li>
            `;

            const fileStats = document.getElementById('model-file-stats');
            const modelFiles = modelInfo.files.filter(f => f.type === 'model');
            const configFiles = modelInfo.config_files || [];
            const tokenizerFiles = modelInfo.tokenizer_files || [];

            fileStats.innerHTML = `
                <li>模型文件: ${modelFiles.length}</li>
                <li>配置文件: ${configFiles.length}</li>
                <li>分词器文件: ${tokenizerFiles.length}</li>
                <li>总文件数: ${modelInfo.files.length}</li>
            `;
        }

        // 切换模型模式
        function toggleModelMode() {
            const selectedMode = document.querySelector('input[name="model-mode"]:checked').value;
            const autoSection = document.getElementById('auto-model-section');
            const manualSection = document.getElementById('manual-model-section');
            const detailsDiv = document.getElementById('model-details');

            if (selectedMode === 'auto') {
                autoSection.style.display = 'block';
                manualSection.style.display = 'none';
                logMessage('info', '切换到自动发现模式');
            } else {
                autoSection.style.display = 'none';
                manualSection.style.display = 'block';
                detailsDiv.style.display = 'none';
                logMessage('info', '切换到手动输入模式');
            }
        }

        // 检查量化支持
        async function checkQuantizationSupport() {
            try {
                logMessage('info', '正在检查量化支持...');
                const result = await callAPI('check_quantization_support');

                if (result.status === 'success') {
                    displayQuantizationInfo(result.support_info);
                } else {
                    document.getElementById('quantization-info').innerHTML =
                        `<div style="color: #ff4757;">❌ 检查量化支持失败: ${result.message}</div>`;
                }
            } catch (error) {
                document.getElementById('quantization-info').innerHTML =
                    `<div style="color: #ff4757;">❌ 检查量化支持时出错: ${error.message}</div>`;
            }
        }

        // 显示量化信息
        function displayQuantizationInfo(info) {
            const infoDiv = document.getElementById('quantization-info');

            if (info.quantization_ready) {
                const gpuInfo = info.cuda_available ? info.gpu_name || '可用' : '不可用';
                infoDiv.innerHTML = `
                    <div style="color: #2ed573;">✅ 量化训练支持完整</div>
                    <div>GPU: ${gpuInfo} | PyTorch: ${info.torch_version}</div>
                `;
            } else {
                const recommendations = info.recommendations.join('<br>');
                const gpuInfo = info.cuda_available ? info.gpu_name || '可用' : '不可用';
                infoDiv.innerHTML = `
                    <div style="color: #ff9f43;">⚠️ 量化训练支持不完整</div>
                    <div>GPU: ${gpuInfo} | PyTorch: ${info.torch_version}</div>
                    <div style="margin-top: 5px;">${recommendations}</div>
                `;
            }

            logMessage('info', info.quantization_ready ? '量化支持检查通过' : '量化支持不完整');
        }

        // 开始LoRA微调
        async function startFineTuning() {
            logMessage('info', '开始LoRA微调函数被调用');

            // 检查是否已经在训练中
            if (trainingState === 'starting' || trainingState === 'active') {
                logMessage('warning', '训练已在进行中，请等待完成');
                return;
            }

            // 先检查元素是否存在
            const fileInput = document.getElementById('training-data');
            if (!fileInput) {
                logMessage('error', '找不到training-data文件输入元素');
                alert('页面元素错误：找不到文件上传控件，请刷新页面重试');
                return;
            }

            // 检查是否已选择文件
            if (!fileInput.files || fileInput.files.length === 0) {
                showTemporaryMessage('请先上传训练数据文件', 'warning');
                alert('请先上传训练数据文件');
                return;
            }


            // 获取模型路径
            let modelPath;
            const selectedMode = document.querySelector('input[name="model-mode"]:checked');
            if (!selectedMode) {
                logMessage('error', '没有选择模型模式');
                return;
            }

            if (selectedMode.value === 'auto') {
                const modelSelector = document.getElementById('model-selector');
                if (!modelSelector) {
                    logMessage('error', '找不到model-selector元素');
                    alert('页面元素错误，请刷新页面重试');
                    return;
                }
                modelPath = modelSelector.value;
            } else {
                const modelPathInput = document.getElementById('model-path');
                if (!modelPathInput) {
                    logMessage('error', '找不到model-path元素');
                    alert('页面元素错误，请刷新页面重试');
                    return;
                }
                modelPath = modelPathInput.value;
            }

            if (!modelPath || modelPath.trim() === '') {
                alert('请选择或输入模型路径');
                logMessage('error', '模型路径为空');
                return;
            }

            // 检查量化选项
            const quantizationRadio = document.querySelector('input[name="quantization"]:checked');
            if (!quantizationRadio) {
                alert('请选择量化选项');
                logMessage('error', '没有选择量化选项');
                return;
            }
            const quantization = quantizationRadio.value;

            // 获取训练参数
            const epochsInput = document.getElementById('epochs');
            const batchSizeInput = document.getElementById('batch-size');
            const learningRateInput = document.getElementById('learning-rate');

            if (!epochsInput || !batchSizeInput || !learningRateInput) {
                alert('页面元素错误，请刷新页面重试');
                logMessage('error', '找不到训练参数输入元素');
                return;
            }

            const epochs = epochsInput.value;
            const batchSize = batchSizeInput.value;
            const learningRate = learningRateInput.value;

            logMessage('info', `训练参数: 模型=${modelPath}, 量化=${quantization}, epochs=${epochs}, batch_size=${batchSize}, lr=${learningRate}`);

            const formData = new FormData();
            formData.append('training_data', fileInput.files[0]);
            formData.append('model_path', modelPath); // 添加模型路径
            formData.append('epochs', epochs);
            formData.append('batch_size', batchSize);
            formData.append('learning_rate', learningRate);
            formData.append('use_4bit', quantization === '4bit' ? 'true' : 'false');
            formData.append('use_8bit', quantization === '8bit' ? 'true' : 'false');

            // 设置训练状态为启动中
            trainingState = 'starting';

            // 更新按钮状态为启动中
            const startBtn = document.getElementById('start-training-btn');
            if (startBtn) {
                startBtn.disabled = true;
                startBtn.textContent = '🚀 正在启动训练...';
                startBtn.style.background = '#ff9f43'; // 橙色表示启动中
            }

            logMessage('info', `开始${quantization}量化LoRA微调，模型路径: ${modelPath}`);

            try {
                logMessage('info', '正在发送API请求...');
                const result = await callAPI('start_finetuning', 'POST', formData);

                logMessage('info', `API响应: ${JSON.stringify(result)}`);

                if (result.status === 'success') {
                    currentTrainingConfig = result.config || {};
                    logMessage('info', `${quantization}量化微调已开始，模型将保存到: ${result.output_dir || '未知路径'}`);

                    // 训练成功启动后，设置状态为活跃并更新按钮
                    trainingState = 'active';

                    // 训练成功启动后，更新按钮状态为训练中
                    if (startBtn) {
                        startBtn.textContent = '🔄 模型加载中...';
                        startBtn.style.background = '#ff9f43'; // 保持橙色
                    }

                    // 显示训练详细信息
                    const detailsDiv = document.getElementById('training-details');
                    if (detailsDiv) {
                        detailsDiv.style.display = 'block';

                        const quantizationSpan = document.getElementById('training-quantization');
                        const batchSizeSpan = document.getElementById('training-batch-size');

                        if (quantizationSpan) quantizationSpan.textContent = (result.config && result.config.quantization) || quantization;
                        if (batchSizeSpan) batchSizeSpan.textContent = (result.config && result.config.batch_size) || batchSize;
                    }

                    // 开始更新进度
                    logMessage('info', '开始监控训练进度');
                    updateTrainingProgress();
                } else {
                    logMessage('error', `微调启动失败: ${result.message || '未知错误'}`);

                    // 启动失败时重置状态和按钮
                    trainingState = 'failed';

                    // 启动失败时恢复按钮
                    if (startBtn) {
                        startBtn.disabled = false;
                        startBtn.textContent = '🚀 开始LoRA微调';
                        startBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    }
                    // 3秒后重置状态
                    setTimeout(() => {
                        rainingState = 'idle';
                    }, 3000);
                }
            } catch (error) {
                logMessage('error', `微调启动出错: ${error.message}`);
                console.error('微调启动详细错误:', error);

                // 出错时重置状态和按钮
                trainingState = 'failed';
                if (startBtn) {
                    startBtn.disabled = false;
                    startBtn.textContent = '🚀 开始LoRA微调';
                    startBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }
                // 3秒后重置状态
                setTimeout(() => {
                    trainingState = 'idle';
                }, 3000);
            }
        }

        // 手动清理内存
        async function manualCleanup() {
            try {
                logMessage('info', '开始手动清理所有模型内存...');

                const result = await callAPI('manual_cleanup', 'POST');

                if (result.status === 'success') {
                    logMessage('success', `${result.details.join(', ')}`);
                    alert(`内存清理完成！\n${result.details.join('\n')}`);
                } else {
                    logMessage('error', `手动清理失败: ${result.message}`);
                    alert(`清理失败: ${result.message}`);
                }
            } catch (error) {
                logMessage('error', `清理出错: ${error.message}`);
                alert(`清理出错: ${error.message}`);
            }
        }

        // 更新训练进度
        async function updateTrainingProgress() {
            try {
                const result = await callAPI('training_progress');
                const startBtn = document.getElementById('start-training-btn');

                if (result.status === 'success') {
                    const progress = result.progress;

                    document.getElementById('training-progress').style.width = `${progress}%`;
                    document.getElementById('progress-text').textContent = `${progress}%`;

                    // 修复：先检查是否完成，再检查是否活跃
                    if (startBtn && (trainingState === 'starting' || trainingState === 'active')) {

                        if (progress >= 100) {
                            // 训练完成 - 优先检查这个条件
                            trainingState = 'completed';
                            startBtn.textContent = '✅ 训练完成';
                            startBtn.style.background = 'linear-gradient(135deg, #2ed573, #17d0aa)';
                            startBtn.disabled = false;

                            logMessage('info', `${currentTrainingConfig?.quantization || ''}量化LoRA微调完成`);
                            logMessage('info', '正在自动清理训练模型内存...');

                            // 5秒后恢复初始状态
                            setTimeout(() => {
                                if (startBtn && trainingState === 'completed') {
                                    startBtn.textContent = '🚀 开始LoRA微调';
                                    startBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                                    trainingState = 'idle';
                                }
                            }, 5000);

                            // 延迟隐藏训练详情
                            setTimeout(() => {
                                const detailsDiv = document.getElementById('training-details');
                                if (detailsDiv) detailsDiv.style.display = 'none';
                            }, 8000);

                            // 刷新模型列表
                            setTimeout(discoverModels, 1000);

                        } else if (result.error) {
                            // 训练出错
                            trainingState = 'failed';
                            startBtn.textContent = '❌ 训练失败';
                            startBtn.style.background = 'linear-gradient(135deg, #ff4757, #ff6b7a)';
                            startBtn.disabled = false;

                            logMessage('error', `训练失败: ${result.error}`);
                            alert('训练失败: ' + result.error);

                            const detailsDiv = document.getElementById('training-details');
                            if (detailsDiv) detailsDiv.style.display = 'none';

                            // 3秒后恢复初始状态
                            setTimeout(() => {
                                if (startBtn && trainingState === 'failed') {
                                    startBtn.textContent = '🚀 开始LoRA微调';
                                    startBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                                    trainingState = 'idle';
                                }
                            }, 3000);

                        } else if (result.active) {
                            // 训练仍在进行中
                            trainingState = 'active';

                            if (progress < 15) {
                                // 0-15%: 模型加载和准备阶段
                                startBtn.textContent = '🔄 模型加载中...';
                                startBtn.style.background = '#ff9f43';
                            } else {
                                // 15-99%: 真实的训练进度
                                startBtn.textContent = `⚡ 训练中 ${progress}%`;
                                startBtn.style.background = 'linear-gradient(135deg, #ff6b7a, #ff4757)';
                            }
                            startBtn.disabled = true;

                        } else {
                            // result.active 为 false 但 progress < 100，可能是训练刚结束但状态还没更新
                            // 保持当前状态，等待下次更新
                            logMessage('info', `训练状态不明确: progress=${progress}, active=${result.active}`);
                        }
                    }

                    // 更新剩余时间
                    if (result.estimated_remaining_seconds) {
                        const remainingMinutes = Math.ceil(result.estimated_remaining_seconds / 60);
                        const remainingElement = document.getElementById('training-remaining');
                        if (remainingElement) {
                            remainingElement.textContent = `${remainingMinutes}分钟`;
                        }
                    }

                    // 更新开始时间
                    if (result.start_time) {
                        const startTime = new Date(result.start_time).toLocaleTimeString();
                        const timeElement = document.getElementById('progress-time');
                        if (timeElement) {
                            timeElement.textContent = `开始时间: ${startTime}`;
                        }
                    }

                    // 继续监控训练进度 - 只有在未完成且无错误时才继续
                    if (progress < 100 && !result.error && trainingState === 'active') {
                        setTimeout(updateTrainingProgress, 2000);
                    }
                }
            } catch (error) {
                logMessage('error', `获取训练进度失败: ${error.message}`);

                // 网络错误时，如果正在训练中，显示网络异常但不改变训练状态
                const startBtn = document.getElementById('start-training-btn');
                if (startBtn && trainingState === 'active') {
                    startBtn.textContent = '🔗 网络异常，重试中...';
                    startBtn.style.background = '#ff9f43';

                    // 3秒后重试
                    setTimeout(() => {
                        if (trainingState === 'active') {
                            updateTrainingProgress();
                        }
                    }, 3000);
                }
            }
        }

        // ======= 第二页：问答相关函数 =======

        // 加载聊天模型
        async function loadChatModel() {
            const modelPath = document.getElementById('chat-model-selector').value;

            if (!modelPath) {
                alert('请选择要加载的模型');
                return;
            }

            const loadBtn = document.getElementById('load-chat-model-btn');
            loadBtn.disabled = true;
            loadBtn.textContent = '📥 正在加载...';

            logMessage('info', `正在加载模型: ${modelPath}`);

            try {
                const result = await callAPI('load_model', 'POST', {
                    model_path: modelPath,
                    use_4bit: true,
                    use_8bit: false
                });

                if (result.status === 'success') {
                    modelLoaded = true;
                    const quantization = result.quantization || 'unknown';
                    document.getElementById('model-status').textContent = `● 模型已加载 (${quantization})`;
                    document.getElementById('model-status').className = 'status-indicator status-online';
                    loadBtn.textContent = `✓ 模型已加载 (${quantization})`;
                    logMessage('info', `模型加载成功，使用${quantization}量化`);
                } else {
                    logMessage('error', `模型加载失败: ${result.message}`);
                    alert('模型加载失败: ' + result.message);
                }
            } catch (error) {
                logMessage('error', `模型加载出错: ${error.message}`);
                alert('模型加载出错: ' + error.message);
            } finally {
                loadBtn.disabled = false;
                if (!modelLoaded) {
                    loadBtn.textContent = '📥 加载模型';
                }
            }
        }

        // 卸载聊天模型
        async function unloadChatModel() {
            const result = await callAPI('unload_model', 'POST');

            if (result.status === 'success') {
                modelLoaded = false;
                document.getElementById('model-status').textContent = '● 模型未加载';
                document.getElementById('model-status').className = 'status-indicator status-offline';

                const loadBtn = document.getElementById('load-chat-model-btn');
                loadBtn.textContent = '📥 加载模型';

                logMessage('info', '模型已卸载');
            } else {
                logMessage('error', `模型卸载失败: ${result.message}`);
            }
        }

        // 连接Neo4j
        async function connectNeo4j() {
            const uri = document.getElementById('neo4j-uri').value;
            const user = document.getElementById('neo4j-user').value;
            const password = document.getElementById('neo4j-password').value;

            logMessage('info', '正在连接Neo4j数据库...');

            const result = await callAPI('connect_neo4j', 'POST', {
                uri: uri,
                user: user,
                password: password
            });

            if (result.status === 'success') {
                neo4jConnected = true;
                document.getElementById('neo4j-status').textContent = '● 数据库已连接';
                document.getElementById('neo4j-status').className = 'status-indicator status-online';
                logMessage('info', 'Neo4j连接成功');
            } else {
                logMessage('error', `Neo4j连接失败: ${result.message}`);
                alert('Neo4j连接失败: ' + result.message);
            }
        }

        // 断开Neo4j连接
        async function disconnectNeo4j() {
            const result = await callAPI('disconnect_neo4j', 'POST');
            if (result.status === 'success') {
                neo4jConnected = false;
                document.getElementById('neo4j-status').textContent = '● 数据库未连接';
                document.getElementById('neo4j-status').className = 'status-indicator status-offline';
                logMessage('info', 'Neo4j已断开连接');
            }
        }

        // 生成示例知识
        async function generateSampleKnowledge() {
            if (!neo4jConnected) {
                alert('请先连接Neo4j数据库');
                return;
            }

            logMessage('info', '正在生成示例知识...');

            const result = await callAPI('generate_sample_knowledge', 'POST');

            if (result.status === 'success') {
                logMessage('info', '示例知识生成成功');
                alert('示例知识生成成功！现在可以开始智能问答了。');
            } else {
                logMessage('error', `示例知识生成失败: ${result.message}`);
                alert('示例知识生成失败: ' + result.message);
            }
        }

        // 发送消息
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;
            
            // 先检查模型状态
            console.log('发送消息前检查模型状态...');
            await debugModelStatus();

            if (!modelLoaded) {
                alert('请先加载模型！');
                return;
            }

            // 添加用户消息到聊天框
            const chatContainer = document.getElementById('chat-messages');
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message chat-user';
            userMsg.innerHTML = `<strong>👤 你:</strong> ${message}`;
            chatContainer.appendChild(userMsg);

            input.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // 显示正在思考的消息
            const thinkingMsg = document.createElement('div');
            thinkingMsg.className = 'chat-message chat-assistant';
            thinkingMsg.innerHTML = '<strong>🤖 PEPPER:</strong> 正在思考中...';
            chatContainer.appendChild(thinkingMsg);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                // 如果连接了知识图谱，使用知识增强的问答
                let result;
                console.log('Neo4j连接状态:', neo4jConnected);
                
                if (neo4jConnected) {
                    console.log('使用知识图谱增强对话');
                    result = await callAPI('chat', 'POST', {
                        message: message,
                        use_knowledge_graph: true
                    });
                } else {
                    console.log('使用基本模型对话');
                    // 使用test_model API确保兼容性
                    result = await callAPI('test_model', 'POST', {
                        question: message,
                        temperature: parseFloat(document.getElementById('temperature').value),
                        max_tokens: parseInt(document.getElementById('max-tokens').value)
                    });
                }

                console.log('API响应:', result);

                // 移除思考消息
                chatContainer.removeChild(thinkingMsg);

                if (result.status === 'success') {
                    const response = result.response || result.result || '无回应';
                    const assistantMsg = document.createElement('div');
                    assistantMsg.className = 'chat-message chat-assistant';
                    assistantMsg.innerHTML = `<strong>🤖 PEPPER:</strong> ${response}`;
                    chatContainer.appendChild(assistantMsg);
                } else {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'chat-message chat-assistant';
                    errorMsg.innerHTML = `<strong>🤖 PEPPER:</strong> 抱歉，处理您的问题时出现了错误：${result.message}`;
                    chatContainer.appendChild(errorMsg);
                    
                    console.error('API错误详情:', result);
                }

                chatContainer.scrollTop = chatContainer.scrollHeight;
                logMessage('info', `问答完成: ${message.substring(0, 50)}...`);

            } catch (error) {
                // 移除思考消息
                if (chatContainer.contains(thinkingMsg)) {
                    chatContainer.removeChild(thinkingMsg);
                }

                const errorMsg = document.createElement('div');
                errorMsg.className = 'chat-message chat-assistant';
                errorMsg.innerHTML = `<strong>🤖 PEPPER:</strong> 连接错误，请检查网络或重试。详情: ${error.message}`;
                chatContainer.appendChild(errorMsg);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                console.error('发送消息详细错误:', error);
                logMessage('error', `发送消息失败: ${error.message}`);
            }
        }

        async function debugModelStatus() {
            try {
                const result = await callAPI('debug_model_status');
                console.log('模型调试信息:', result);
                
                if (result.status === 'success') {
                    const info = result.debug_info;
                    let debugMessage = `
        模型调试信息:
        - services['llm'] 存在: ${info.services_llm_exists}
        - 模型类型: ${info.services_llm_type || '无'}
        - 系统状态-模型已加载: ${info.system_status_model_loaded}
        - 模型路径: ${info.system_status_model_path || '无'}
        - 量化方式: ${info.system_status_quantization || '无'}
        - 有generate_response方法: ${info.has_generate_response}
        - Neo4j已连接: ${info.neo4j_connected}
        - 知识图谱存在: ${info.knowledge_graph_exists}
                    `;
                    console.log('模型调试信息:',debugMessage);
                    logMessage('info', '模型调试信息已输出到控制台');
                } else {
                    alert('获取调试信息失败: ' + result.message);
                }
            } catch (error) {
                console.error('调试失败:', error);
                alert('调试失败: ' + error.message);
            }
        }

        // 清空对话
        function clearChat() {
            const chatContainer = document.getElementById('chat-messages');
            chatContainer.innerHTML = `
                <div class="chat-message chat-assistant">
                    <strong>🤖 PEPPER:</strong> 对话已清空，请继续提问！
                </div>
            `;
            logMessage('info', '对话已清空');
        }

        // 测试模型连接
        async function testModelConnection() {
            if (!modelLoaded) {
                alert('请先加载模型！');
                return;
            }

            const testQuestions = [
                'Python中for循环和while循环有什么区别？'
            ];

            const randomQuestion = testQuestions[Math.floor(Math.random() * testQuestions.length)];

            document.getElementById('chat-input').value = randomQuestion;
            sendMessage();
        }

        // 更新预计训练时间
        function updateEstimatedTime() {
            const epochs = parseInt(document.getElementById('epochs').value);
            const batchSize = parseInt(document.getElementById('batch-size').value);
            const quantization = document.querySelector('input[name="quantization"]:checked').value;

            let baseTimePerEpoch = 5; // 分钟

            if (quantization === '4bit') {
                baseTimePerEpoch *= 1.2;
            } else if (quantization === '8bit') {
                baseTimePerEpoch *= 1.1;
            }

            baseTimePerEpoch *= (4 / batchSize);

            const totalMinutes = epochs * baseTimePerEpoch;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);

            let timeText = '';
            if (hours > 0) {
                timeText = `约${hours}小时${minutes}分钟`;
            } else {
                timeText = `约${minutes}分钟`;
            }

            document.getElementById('estimated-time').textContent = timeText;
        }

        // 事件监听器设置
        /* function setupEventListeners() {
            // 文件上传显示和验证
            const trainingDataInput = document.getElementById('training-data');
            if (trainingDataInput) {
                trainingDataInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // 验证文件类型
                        const validTypes = ['.json', '.csv'];
                        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

                        if (!validTypes.includes(fileExtension)) {
                            alert('请选择JSON或CSV格式的文件');
                            e.target.value = ''; // 清空选择
                            return;
                        }

                        // 验证文件大小 (限制为16MB)
                        if (file.size > 16 * 1024 * 1024) {
                            alert('文件大小不能超过16MB');
                            e.target.value = ''; // 清空选择
                            return;
                        }

                        // 更新显示
                        const uploadArea = document.querySelector('.file-upload');
                        if (uploadArea) {
                            uploadArea.innerHTML = `
                                <input type="file" id="training-data" accept=".json,.csv" style="display: none;">
                                <p>✅ 已选择文件: ${file.name}</p>
                                <small>大小: ${(file.size / 1024).toFixed(2)} KB | 点击可重新选择</small>
                            `;
                            uploadArea.style.borderColor = '#2ed573';
                            uploadArea.style.background = 'rgba(46, 213, 115, 0.1)';

                            // 重新绑定点击事件
                            uploadArea.onclick = function() {
                                document.getElementById('training-data').click();
                            };
                        }

                        logMessage('info', `已选择训练数据文件: ${file.name}`);
                    }
                });
            } else {
                logMessage('error', '找不到training-data元素，文件上传功能无法初始化');
            }

            // 确保文件上传区域的点击事件
            const fileUploadDiv = document.querySelector('.file-upload');
            if (fileUploadDiv) {
                fileUploadDiv.addEventListener('click', function() {
                    const input = document.getElementById('training-data');
                    if (input) {
                        input.click();
                    } else {
                        logMessage('error', '文件输入元素不存在');
                    }
                });
            }
        } */

        // 文件上传处理函数
        function setupFileUpload() {
            const fileInput = document.getElementById('training-data');

            if (!fileInput) {
                logMessage('error', '找不到文件输入元素');
                return;
            }

            // 移除之前的事件监听器
            const newFileInput = fileInput.cloneNode(true);
            fileInput.parentNode.replaceChild(newFileInput, fileInput);

            // 添加新的事件监听器
            const currentFileInput = document.getElementById('training-data');
            currentFileInput.addEventListener('change', handleFileChange);

            logMessage('info', '文件上传功能已初始化');
        }

        function handleFileChange(e) {
            const file = e.target.files[0];
            const fileInfo = document.getElementById('file-info');
            const fileUploadArea = document.getElementById('file-upload-area');

            if (!file) {
                // 如果没有选择文件，隐藏文件信息
                if (fileInfo) fileInfo.style.display = 'none';
                resetFileUploadArea();
                return;
            }

            // 验证文件类型
            const validTypes = ['.json', '.csv'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

            if (!validTypes.includes(fileExtension)) {
                showTemporaryMessage('请选择JSON或CSV格式的文件', 'error');
                e.target.value = '';
                if (fileInfo) fileInfo.style.display = 'none';
                resetFileUploadArea();
                setTimeout(setupFileUpload, 100);
                return;
            }

            // 验证文件大小 (限制为16MB)
            if (file.size > 16 * 1024 * 1024) {
                showTemporaryMessage('文件大小不能超过16MB', 'error');
                e.target.value = '';
                if (fileInfo) fileInfo.style.display = 'none';
                resetFileUploadArea();
                setTimeout(setupFileUpload, 100);
                return;
            }

            // 显示文件信息
            displayFileInfo(file);
            updateFileUploadArea();

            logMessage('info', `已选择训练数据文件: ${file.name} (${formatFileSize(file.size)})`);
            showTemporaryMessage(`文件上传成功: ${file.name}`, 'success');
        }

        function removeUploadedFile() {
            // 阻止事件冒泡
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            const fileInput = document.getElementById('training-data');
            const fileInfo = document.getElementById('file-info');

            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                // 获取文件名用于日志
                const fileName = fileInput.files[0].name;

                // 清空文件选择
                const newFileInput = fileInput.cloneNode(true);
                newFileInput.value = '';
                fileInput.parentNode.replaceChild(newFileInput, fileInput);

                // 隐藏文件信息
                if (fileInfo) {
                    fileInfo.style.display = 'none';
                }

                // 重置文件上传区域
                resetFileUploadArea();

                logMessage('info', `已删除上传的文件: ${fileName}`);

                // 可选：显示删除成功的临时提示
                showTemporaryMessage('文件已删除', 'success');

                // 重新初始化文件上传功能
                setTimeout(() => {
                    setupFileUpload();
                }, 100);
            } else {
                logMessage('warning', '没有找到要删除的文件');
                showTemporaryMessage('没有文件可删除', 'warning');
            }
        }

        // 显示临时提示消息
        function showTemporaryMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;

            // 根据类型设置颜色
            switch(type) {
                case 'success':
                    messageDiv.style.background = 'linear-gradient(135deg, #2ed573, #17d0aa)';
                    break;
                case 'error':
                    messageDiv.style.background = 'linear-gradient(135deg, #ff4757, #ff6b7a)';
                    break;
                case 'warning':
                    messageDiv.style.background = 'linear-gradient(135deg, #ff9f43, #ffa801)';
                    break;
                default:
                    messageDiv.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
            }

            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);

            // 3秒后自动消失
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(messageDiv)) {
                        document.body.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }

        function displayFileInfo(file) {
            const fileName = document.getElementById('file-name');
            const fileDetails = document.getElementById('file-details');
            const fileInfo = document.getElementById('file-info');

            if (fileName && fileDetails && fileInfo) {
                const fileSize = formatFileSize(file.size);
                const fileType = file.name.split('.').pop().toUpperCase();
                const uploadTime = new Date().toLocaleString();

                fileName.textContent = file.name;
                fileDetails.innerHTML = `
                    <span>📊 类型: ${fileType}</span> •
                    <span>📦 大小: ${fileSize}</span> •
                    <span>⏰ 上传时间: ${uploadTime}</span>
                `;

                fileInfo.style.display = 'block';
            }
        }

        function updateFileUploadArea() {
            const fileUploadArea = document.getElementById('file-upload-area');
            if (fileUploadArea) {
                fileUploadArea.innerHTML = `
                    <input type="file" id="training-data" accept=".json,.csv" style="display: none;">
                    <p style="color: #2ed573; font-weight: 600;">✅ 文件已选择</p>
                    <small style="color: #666;">点击可重新选择文件</small>
                `;

                fileUploadArea.style.borderColor = '#2ed573';
                fileUploadArea.style.background = 'rgba(46, 213, 115, 0.05)';

                // 重新绑定事件
                fileUploadArea.onclick = function() {
                    const input = document.getElementById('training-data');
                    if (input) input.click();
                };

                // 重新设置文件上传
                setTimeout(setupFileUpload, 100);
            }
        }

        function resetFileUploadArea() {
            const fileUploadArea = document.getElementById('file-upload-area');
            if (fileUploadArea) {
                fileUploadArea.innerHTML = `
                    <input type="file" id="training-data" accept=".json,.csv" style="display: none;">
                    <p>点击上传训练数据</p>
                    <small>支持JSON/CSV格式</small>
                `;

                fileUploadArea.style.borderColor = '#e1e5e9';
                fileUploadArea.style.background = 'rgba(255, 255, 255, 0.5)';

                fileUploadArea.onclick = function() {
                    const input = document.getElementById('training-data');
                    if (input) input.click();
                };
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';

            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function addDebugButton() {
            const chatPanel = document.querySelector('.panel:has(#chat-messages)');
            if (chatPanel) {
                const debugBtn = document.createElement('button');
                debugBtn.textContent = '🔍 调试模型状态';
                debugBtn.onclick = debugModelStatus;
                debugBtn.style.margin = '5px';
                debugBtn.className = 'btn-secondary';
                
                const formGroup = chatPanel.querySelector('.form-group:last-child');
                if (formGroup) {
                    formGroup.appendChild(debugBtn);
                }
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('info', '智能教学系统界面加载完成');

            // 检查关键元素是否存在
            const criticalElements = {
                'training-data': '训练数据文件输入',
                'model-selector': '模型选择器',
                'model-path': '模型路径输入',
                'epochs': '训练轮数输入',
                'batch-size': '批次大小输入',
                'learning-rate': '学习率输入',
                'start-training-btn': '开始训练按钮'
            };

            let missingElements = [];
            Object.entries(criticalElements).forEach(([id, description]) => {
                if (!document.getElementById(id)) {
                    missingElements.push(`${description}(${id})`);
                }
            });

            if (missingElements.length > 0) {
                logMessage('error', `缺少关键元素: ${missingElements.join(', ')}`);
                alert(`页面加载不完整，缺少元素: ${missingElements.join(', ')}\n请刷新页面重试`);
                return;
            }

            logMessage('info', '所有关键元素检查通过');

            // 设置事件监听器
            // setupEventListeners();

            // 初始化文件上传功能
            setupFileUpload();

            // 自动扫描模型
            setTimeout(() => {
                logMessage('info', '开始自动扫描模型');
                discoverModels();
            }, 2000);

            // 检查量化支持
            setTimeout(() => {
                logMessage('info', '检查量化支持');
                checkQuantizationSupport();
            }, 1000);

            // 更新预计训练时间
            updateEstimatedTime();
            
            // 延迟添加调试按钮，确保页面元素已加载
            setTimeout(addDebugButton, 1000);

            logMessage('info', '系统初始化完成');
        });
    </script>
</body>
</html>