<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PEPPERæ™ºèƒ½æ•™å­¦ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2f3542;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            color: #2f3542;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .nav-tab {
            flex: 1;
            padding: 20px 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 4px solid transparent;
            transition: all 0.3s ease;
            color: #57606f;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-color: #ffffff;
        }

        .nav-tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }

        .panel h2 {
            color: #2f3542;
            margin-bottom: 25px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #57606f;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #a4b0be;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #57606f, #6c7a89);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ed573, #17d0aa);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #ff6b7a);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-online {
            background: linear-gradient(135deg, #2ed573, #17d0aa);
            color: white;
        }

        .status-offline {
            background: linear-gradient(135deg, #ff4757, #ff6b7a);
            color: white;
        }

        .quantization-options {
            margin-bottom: 20px;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-option {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .radio-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .radio-option input[type="radio"] {
            margin-right: 12px;
            margin-top: 2px;
            width: auto;
        }

        .radio-option:has(input:checked) {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .radio-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .radio-label strong {
            font-size: 15px;
            color: #2f3542;
        }

        .radio-label small {
            color: #666;
            font-size: 12px;
        }

        .file-upload {
            border: 3px dashed #e1e5e9;
            border-radius: 12px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.5);
        }

        .file-upload:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e1e5e9;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            border-radius: 15px;
        }

        .progress-container {
            position: relative;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 13px;
            color: #666;
        }

        .model-selector-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .model-select {
            flex: 1;
        }

        .btn-scan {
            padding: 15px 20px;
            white-space: nowrap;
        }

        .scan-status {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            font-size: 13px;
            border-left: 4px solid #667eea;
        }

        .chat-container {
            height: 400px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(248, 249, 255, 0.8);
            backdrop-filter: blur(5px);
        }

        .chat-message {
            margin-bottom: 18px;
            padding: 15px;
            border-radius: 15px;
            max-width: 85%;
            word-wrap: break-word;
        }

        .chat-user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .chat-assistant {
            background: white;
            border: 1px solid #e1e5e9;
            color: #2f3542;
            border-bottom-left-radius: 5px;
        }

        .log-container {
            background: #2f3542;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 20px;
            border-radius: 12px;
            height: 250px;
            overflow-y: auto;
        }

        #quantization-info, #training-details {
            border-left: 4px solid #667eea;
            background: rgba(102, 126, 234, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .grid-2, .form-row {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .model-selector-container {
                flex-direction: column;
            }

            .btn-scan {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– PEPPERæ™ºèƒ½æ•™å­¦ç³»ç»Ÿ</h1>
            <p>åŸºäºDeepSeek-LoRAå¾®è°ƒä¸Neo4jçŸ¥è¯†å›¾è°±çš„å¤šæ¨¡æ€æ™ºèƒ½æ•™è‚²å¹³å°</p>
        </div>

        <!-- å¯¼èˆªæ ‡ç­¾ -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('training')">ğŸ§  LoRAæ¨¡å‹è®­ç»ƒ</button>
            <button class="nav-tab" onclick="showTab('chat')">ğŸ’¬ æ™ºèƒ½é—®ç­”ç³»ç»Ÿ</button>
        </div>

        <!-- LoRAè®­ç»ƒæ ‡ç­¾é¡µ -->
        <div id="training" class="tab-content active">
            <div class="grid-2">
                <div class="panel">
                    <h2>ğŸ“ æ¨¡å‹é€‰æ‹©ä¸ç®¡ç†</h2>
                    
                    <!-- æ¨¡å‹å‘ç°å’Œé€‰æ‹© -->
                    <div class="form-group">
                        <label>é€‰æ‹©åŸºç¡€æ¨¡å‹</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="model-mode" value="auto" checked onchange="toggleModelMode()" style="margin-right: 8px;">
                                <span>ğŸ¯ è‡ªåŠ¨å‘ç°</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="model-mode" value="manual" onchange="toggleModelMode()" style="margin-right: 8px;">
                                <span>âœï¸ æ‰‹åŠ¨è¾“å…¥</span>
                            </label>
                        </div>

                        <!-- è‡ªåŠ¨å‘ç°æ¨¡å¼ -->
                        <div id="auto-model-section">
                            <div class="model-selector-container">
                                <select id="model-selector" class="model-select">
                                    <option value="">ğŸ” é€‰æ‹©ä¸€ä¸ªæ¨¡å‹...</option>
                                </select>
                                <button class="btn-scan" onclick="discoverModels()">
                                    <span>ğŸ”„ æ‰«ææ¨¡å‹</span>
                                </button>
                            </div>
                            <div id="model-scan-status" class="scan-status">
                                ç‚¹å‡»"æ‰«ææ¨¡å‹"æ¥å‘ç°å¯ç”¨çš„æ¨¡å‹
                            </div>
                        </div>

                        <!-- æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ -->
                        <div id="manual-model-section" style="display: none;">
                            <input type="text" id="model-path" 
                                   value="models/deepseek-coder-1.3b-base"
                                   placeholder="è¾“å…¥æ¨¡å‹è·¯å¾„ï¼Œä¾‹å¦‚ï¼šmodels/deepseek-coder-1.3b-base">
                        </div>
                    </div>

                    <!-- æ¨¡å‹è¯¦ç»†ä¿¡æ¯å±•ç¤º -->
                    <div id="model-details" style="display: none; background: rgba(248, 249, 255, 0.8); padding: 20px; border-radius: 12px; margin: 15px 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <strong>ğŸ“Š æ¨¡å‹ä¿¡æ¯</strong>
                                <ul id="model-basic-info" style="margin: 8px 0; padding-left: 20px;">
                                </ul>
                            </div>
                            <div>
                                <strong>ğŸ“ˆ æ–‡ä»¶ç»Ÿè®¡</strong>
                                <ul id="model-file-stats" style="margin: 8px 0; padding-left: 20px;">
                                </ul>
                            </div>
                        </div>
                    </div>

                    <h2>âš™ï¸ é‡åŒ–è®­ç»ƒé…ç½®</h2>
                    
                    <!-- é‡åŒ–é…ç½®éƒ¨åˆ† -->
                    <div class="form-group">
                        <label>é‡åŒ–è®¾ç½®</label>
                        <div class="quantization-options">
                            <div id="quantization-info">
                                <div>ğŸ” æ­£åœ¨æ£€æŸ¥é‡åŒ–æ”¯æŒ...</div>
                            </div>

                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="quantization" value="4bit" checked>
                                    <span class="radio-label">
                                        <strong>4bité‡åŒ–è®­ç»ƒ</strong>
                                        <small>æœ€èŠ‚çœå†…å­˜ï¼Œé€‚åˆä½é…ç½®GPUï¼ˆæ¨èï¼‰</small>
                                    </span>
                                </label>

                                <label class="radio-option">
                                    <input type="radio" name="quantization" value="8bit">
                                    <span class="radio-label">
                                        <strong>8bité‡åŒ–è®­ç»ƒ</strong>
                                        <small>å¹³è¡¡æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨</small>
                                    </span>
                                </label>

                                <label class="radio-option">
                                    <input type="radio" name="quantization" value="full">
                                    <span class="radio-label">
                                        <strong>å…¨ç²¾åº¦è®­ç»ƒ</strong>
                                        <small>æœ€é«˜è´¨é‡ï¼Œéœ€è¦å¤§é‡GPUå†…å­˜</small>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button onclick="checkQuantizationSupport()">ğŸ” æ£€æŸ¥é‡åŒ–æ”¯æŒ</button>
                    </div>
                </div>

                <div class="panel">
                    <h2>ğŸ¯ LoRAè®­ç»ƒå‚æ•°</h2>
                    
                    <div class="form-group">
                        <label>è®­ç»ƒæ•°æ®æ–‡ä»¶</label>
                        <div class="file-upload" id="file-upload-area">
                            <input type="file" id="training-data" accept=".json,.csv" style="display: none;">
                            <p id="upload-text">>ç‚¹å‡»ä¸Šä¼ è®­ç»ƒæ•°æ®</p>
                            <small>æ”¯æŒJSON/CSVæ ¼å¼</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>è®­ç»ƒè½®æ•° (Epochs)</label>
                            <input type="number" id="epochs" value="3" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label>æ‰¹æ¬¡å¤§å° (Batch Size)</label>
                            <input type="number" id="batch-size" value="2" min="1" max="8">
                            <small style="color: #666; font-size: 12px;">4bité‡åŒ–æ¨èä½¿ç”¨2</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>å­¦ä¹ ç‡ (Learning Rate)</label>
                            <input type="number" id="learning-rate" value="0.0002" step="0.0001">
                        </div>
                        <div class="form-group">
                            <label>é¢„è®¡è®­ç»ƒæ—¶é—´</label>
                            <div id="estimated-time" style="padding: 12px; background: rgba(248, 249, 255, 0.8); border-radius: 8px; font-size: 13px;">
                                æ ¹æ®é…ç½®è‡ªåŠ¨è®¡ç®—
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button onclick="startFineTuning()" id="start-training-btn">ğŸš€ å¼€å§‹LoRAå¾®è°ƒ</button>
                    </div>

                    <div class="form-group">
                        <label>è®­ç»ƒè¿›åº¦</label>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="training-progress" style="width: 0%"></div>
                            </div>
                            <div class="progress-info">
                                <span id="progress-text">0%</span>
                                <span id="progress-time"></span>
                            </div>
                        </div>

                        <!-- è¯¦ç»†è®­ç»ƒä¿¡æ¯ -->
                        <div id="training-details" style="display: none;">
                            <div><strong>é‡åŒ–æ–¹å¼:</strong> <span id="training-quantization">-</span></div>
                            <div><strong>æ‰¹æ¬¡å¤§å°:</strong> <span id="training-batch-size">-</span></div>
                            <div><strong>é¢„è®¡å‰©ä½™:</strong> <span id="training-remaining">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ™ºèƒ½é—®ç­”æ ‡ç­¾é¡µ -->
        <div id="chat" class="tab-content">
            <div class="grid-2">
                <div class="panel">
                    <h2>ğŸ¤– æ¨¡å‹åŠ è½½ç®¡ç†</h2>
                    
                    <div class="form-group">
                        <label>æ¨¡å‹çŠ¶æ€</label>
                        <div class="status-indicator status-offline" id="model-status">
                            â— æ¨¡å‹æœªåŠ è½½
                        </div>
                    </div>

                    <div class="form-group">
                        <label>é€‰æ‹©æ¨¡å‹</label>
                        <select id="chat-model-selector">
                            <option value="">é€‰æ‹©è¦åŠ è½½çš„æ¨¡å‹...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <button onclick="loadChatModel()" id="load-chat-model-btn">ğŸ“¥ åŠ è½½æ¨¡å‹</button>
                        <button class="btn-secondary" onclick="unloadChatModel()">ğŸ“¤ å¸è½½æ¨¡å‹</button>
                    </div>

                    <h2>ğŸ—„ï¸ Neo4jçŸ¥è¯†å›¾è°±</h2>
                    
                    <div class="form-group">
                        <label>æ•°æ®åº“è¿æ¥çŠ¶æ€</label>
                        <div class="status-indicator status-offline" id="neo4j-status">
                            â— æ•°æ®åº“æœªè¿æ¥
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>æœåŠ¡å™¨åœ°å€</label>
                            <input type="text" id="neo4j-uri" value="bolt://localhost:7687">
                        </div>
                        <div class="form-group">
                            <label>ç”¨æˆ·å</label>
                            <input type="text" id="neo4j-user" value="neo4j">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" id="neo4j-password" value="admin123">
                    </div>

                    <div class="form-group">
                        <button onclick="connectNeo4j()">ğŸ”— è¿æ¥æ•°æ®åº“</button>
                        <button class="btn-secondary" onclick="disconnectNeo4j()">âŒæ–­å¼€è¿æ¥</button>
                        <button class="btn-success" onclick="generateSampleKnowledge()">ğŸ“š ç”Ÿæˆç¤ºä¾‹çŸ¥è¯†</button>
                    </div>

                    <h2>âš™ï¸ æ¨¡å‹å‚æ•°</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Temperature</label>
                            <input type="range" id="temperature" min="0.1" max="2.0" step="0.1" value="0.7">
                            <span id="temp-value">0.7</span>
                        </div>
                        <div class="form-group">
                            <label>Max Tokens</label>
                            <input type="number" id="max-tokens" value="512" min="50" max="2048">
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2>ğŸ’¬ æ™ºèƒ½å¯¹è¯</h2>
                    
                    <div class="chat-container" id="chat-messages">
                        <div class="chat-message chat-assistant">
                            <strong>ğŸ¤– PEPPER:</strong> ä½ å¥½ï¼æˆ‘æ˜¯åŸºäºDeepSeekå’ŒNeo4jçŸ¥è¯†å›¾è°±çš„AIæ•™å­¦åŠ©æ‰‹ã€‚è¯·å…ˆåŠ è½½æ¨¡å‹å’Œè¿æ¥çŸ¥è¯†å›¾è°±ï¼Œç„¶åå°±å¯ä»¥å¼€å§‹å¯¹è¯äº†ï¼
                        </div>
                    </div>
                    
                    <div class="form-group" style="display: flex; gap: 10px; margin-top: 20px;">
                        <textarea id="chat-input" rows="3" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." style="flex: 1; resize: vertical;"></textarea>
                        <button onclick="sendMessage()" style="width: 100px; height: fit-content;">ğŸ’¬ å‘é€</button>
                    </div>

                    <div class="form-group">
                        <button onclick="clearChat()" class="btn-secondary">ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯</button>
                        <button onclick="testModelConnection()" class="btn-success">ğŸ§ª æµ‹è¯•è¿æ¥</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿæ—¥å¿— -->
        <div class="panel">
            <h2>ğŸ“ ç³»ç»Ÿæ—¥å¿—</h2>
            <div class="log-container" id="system-log">
                [ç³»ç»Ÿ] PEPPERæ™ºèƒ½æ•™å­¦ç³»ç»Ÿå·²å¯åŠ¨ï¼Œç­‰å¾…æ“ä½œ...
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let modelLoaded = false;
        let neo4jConnected = false;
        let discoveredModels = [];
        let selectedModelInfo = null;
        let currentTrainingConfig = null;

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            logMessage('info', `åˆ‡æ¢åˆ°${getTabName(tabName)}é¡µé¢`);
        }

        function getTabName(tabName) {
            const names = {
                'training': 'LoRAæ¨¡å‹è®­ç»ƒ',
                'chat': 'æ™ºèƒ½é—®ç­”ç³»ç»Ÿ'
            };
            return names[tabName] || tabName;
        }

        // æ—¥å¿—è®°å½•
        function logMessage(level, message) {
            const logContainer = document.getElementById('system-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${level.toUpperCase()}] ${message}\n`;
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // APIè°ƒç”¨å‡½æ•°
        async function callAPI(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    if (data instanceof FormData) {
                        delete options.headers['Content-Type'];
                        options.body = data;
                    } else {
                        options.body = JSON.stringify(data);
                    }
                }

                const response = await fetch(`/api/${endpoint}`, options);
                return await response.json();
            } catch (error) {
                logMessage('error', `APIè°ƒç”¨å¤±è´¥: ${error.message}`);
                return { status: 'error', message: error.message };
            }
        }

        // ======= ç¬¬ä¸€é¡µï¼šLoRAè®­ç»ƒç›¸å…³å‡½æ•° =======

        // å‘ç°å¯ç”¨æ¨¡å‹
        async function discoverModels() {
            const scanBtn = document.querySelector('.btn-scan');
            const scanStatus = document.getElementById('model-scan-status');

            scanBtn.textContent = 'ğŸ”„ æ‰«æä¸­...';
            scanStatus.textContent = 'ğŸ” æ­£åœ¨æ‰«ææ¨¡å‹ç›®å½•...';
            scanStatus.style.borderLeftColor = '#ff9f43';

            logMessage('info', 'å¼€å§‹æ‰«ææ¨¡å‹ç›®å½•');

            const result = await callAPI('discover_models');

            scanBtn.textContent = 'ğŸ”„ æ‰«ææ¨¡å‹';

            if (result.status === 'success') {
                discoveredModels = result.models;
                updateModelSelector();
                updateChatModelSelector(); // åŒæ—¶æ›´æ–°é—®ç­”é¡µé¢çš„æ¨¡å‹é€‰æ‹©å™¨

                const validCount = result.models.filter(m => m.valid).length;
                scanStatus.innerHTML = `âœ… å‘ç° <strong>${result.count}</strong> ä¸ªæ¨¡å‹ç›®å½•ï¼Œå…¶ä¸­ <strong>${validCount}</strong> ä¸ªæœ‰æ•ˆ`;
                scanStatus.style.borderLeftColor = '#2ed573';

                logMessage('info', `æ¨¡å‹æ‰«æå®Œæˆï¼Œå‘ç° ${result.count} ä¸ªæ¨¡å‹ç›®å½•`);
            } else {
                scanStatus.innerHTML = `âŒ æ‰«æå¤±è´¥: ${result.message}`;
                scanStatus.style.borderLeftColor = '#ff4757';
                logMessage('error', `æ¨¡å‹æ‰«æå¤±è´¥: ${result.message}`);
            }
        }

        // æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨
        function updateModelSelector() {
            const selector = document.getElementById('model-selector');
            selector.innerHTML = '<option value="">ğŸ¯ é€‰æ‹©ä¸€ä¸ªæ¨¡å‹...</option>';

            if (discoveredModels.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'ğŸ˜” æœªå‘ç°ä»»ä½•æ¨¡å‹';
                option.disabled = true;
                selector.appendChild(option);
                return;
            }

            discoveredModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.path;

                if (model.valid) {
                    option.textContent = `${model.display_name}`;
                    option.style.color = '#2f3542';
                } else {
                    option.textContent = `${model.display_name} (âš ï¸ ä¸å®Œæ•´)`;
                    option.style.color = '#ff6b7a';
                    option.style.fontStyle = 'italic';
                }

                selector.appendChild(option);
            });

            selector.removeEventListener('change', onModelSelect);
            selector.addEventListener('change', onModelSelect);
        }

        // æ›´æ–°é—®ç­”é¡µé¢çš„æ¨¡å‹é€‰æ‹©å™¨
        function updateChatModelSelector() {
            const selector = document.getElementById('chat-model-selector');
            selector.innerHTML = '<option value="">é€‰æ‹©è¦åŠ è½½çš„æ¨¡å‹...</option>';

            if (discoveredModels.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'ğŸ˜” æœªå‘ç°ä»»ä½•æ¨¡å‹';
                option.disabled = true;
                selector.appendChild(option);
                return;
            }

            discoveredModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.path;
                option.textContent = model.valid ? model.display_name : `${model.display_name} (âš ï¸ ä¸å®Œæ•´)`;
                selector.appendChild(option);
            });
        }

        // æ¨¡å‹é€‰æ‹©äº‹ä»¶å¤„ç†
        async function onModelSelect(event) {
            const selectedPath = event.target.value;
            const pathInput = document.getElementById('model-path');
            const detailsDiv = document.getElementById('model-details');

            if (selectedPath) {
                pathInput.value = selectedPath;
                await loadModelDetails(selectedPath);
                detailsDiv.style.display = 'block';
                logMessage('info', `å·²é€‰æ‹©æ¨¡å‹: ${selectedPath}`);
            } else {
                detailsDiv.style.display = 'none';
                selectedModelInfo = null;
            }
        }

        // åŠ è½½æ¨¡å‹è¯¦ç»†ä¿¡æ¯
        async function loadModelDetails(modelPath) {
            const result = await callAPI('get_model_info', 'POST', { model_path: modelPath });

            if (result.status === 'success') {
                selectedModelInfo = result.model_info;
                displayModelDetails(selectedModelInfo);
            } else {
                logMessage('error', `è·å–æ¨¡å‹ä¿¡æ¯å¤±è´¥: ${result.message}`);
            }
        }

        // æ˜¾ç¤ºæ¨¡å‹è¯¦ç»†ä¿¡æ¯
        function displayModelDetails(modelInfo) {
            const basicInfo = document.getElementById('model-basic-info');
            basicInfo.innerHTML = `
                <li>åç§°: ${modelInfo.name}</li>
                <li>ç±»å‹: ${modelInfo.model_type || 'æœªçŸ¥'}</li>
                <li>å¤§å°: ${modelInfo.total_size_display}</li>
                <li>è¯æ±‡é‡: ${modelInfo.vocab_size ? modelInfo.vocab_size.toLocaleString() : 'æœªçŸ¥'}</li>
            `;

            const fileStats = document.getElementById('model-file-stats');
            const modelFiles = modelInfo.files.filter(f => f.type === 'model');
            const configFiles = modelInfo.config_files || [];
            const tokenizerFiles = modelInfo.tokenizer_files || [];

            fileStats.innerHTML = `
                <li>æ¨¡å‹æ–‡ä»¶: ${modelFiles.length}</li>
                <li>é…ç½®æ–‡ä»¶: ${configFiles.length}</li>
                <li>åˆ†è¯å™¨æ–‡ä»¶: ${tokenizerFiles.length}</li>
                <li>æ€»æ–‡ä»¶æ•°: ${modelInfo.files.length}</li>
            `;
        }

        // åˆ‡æ¢æ¨¡å‹æ¨¡å¼
        function toggleModelMode() {
            const selectedMode = document.querySelector('input[name="model-mode"]:checked').value;
            const autoSection = document.getElementById('auto-model-section');
            const manualSection = document.getElementById('manual-model-section');
            const detailsDiv = document.getElementById('model-details');

            if (selectedMode === 'auto') {
                autoSection.style.display = 'block';
                manualSection.style.display = 'none';
                logMessage('info', 'åˆ‡æ¢åˆ°è‡ªåŠ¨å‘ç°æ¨¡å¼');
            } else {
                autoSection.style.display = 'none';
                manualSection.style.display = 'block';
                detailsDiv.style.display = 'none';
                logMessage('info', 'åˆ‡æ¢åˆ°æ‰‹åŠ¨è¾“å…¥æ¨¡å¼');
            }
        }

        // æ£€æŸ¥é‡åŒ–æ”¯æŒ
        async function checkQuantizationSupport() {
            try {
                logMessage('info', 'æ­£åœ¨æ£€æŸ¥é‡åŒ–æ”¯æŒ...');
                const result = await callAPI('check_quantization_support');

                if (result.status === 'success') {
                    displayQuantizationInfo(result.support_info);
                } else {
                    document.getElementById('quantization-info').innerHTML =
                        `<div style="color: #ff4757;">âŒ æ£€æŸ¥é‡åŒ–æ”¯æŒå¤±è´¥: ${result.message}</div>`;
                }
            } catch (error) {
                document.getElementById('quantization-info').innerHTML =
                    `<div style="color: #ff4757;">âŒ æ£€æŸ¥é‡åŒ–æ”¯æŒæ—¶å‡ºé”™: ${error.message}</div>`;
            }
        }

        // æ˜¾ç¤ºé‡åŒ–ä¿¡æ¯
        function displayQuantizationInfo(info) {
            const infoDiv = document.getElementById('quantization-info');

            if (info.quantization_ready) {
                infoDiv.innerHTML = `
                    <div style="color: #2ed573;">âœ… é‡åŒ–è®­ç»ƒæ”¯æŒå®Œæ•´</div>
                    <div>GPU: ${info.cuda_available ? 'å¯ç”¨' : 'ä¸å¯ç”¨'} | PyTorch: ${info.torch_version}</div>
                `;
            } else {
                const recommendations = info.recommendations.join('<br>');
                infoDiv.innerHTML = `
                    <div style="color: #ff9f43;">âš ï¸ é‡åŒ–è®­ç»ƒæ”¯æŒä¸å®Œæ•´</div>
                    <div style="margin-top: 5px;">${recommendations}</div>
                `;
            }

            logMessage('info', info.quantization_ready ? 'é‡åŒ–æ”¯æŒæ£€æŸ¥é€šè¿‡' : 'é‡åŒ–æ”¯æŒä¸å®Œæ•´');
        }

        // å¼€å§‹LoRAå¾®è°ƒ
        async function startFineTuning() {
            logMessage('info', 'å¼€å§‹LoRAå¾®è°ƒå‡½æ•°è¢«è°ƒç”¨');
            
            // å…ˆæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            const fileInput = document.getElementById('training-data');
            
            if (!fileInput.files[0]) {
                alert('è¯·å…ˆä¸Šä¼ è®­ç»ƒæ•°æ®');
                logMessage('error', 'æ²¡æœ‰é€‰æ‹©è®­ç»ƒæ•°æ®æ–‡ä»¶');
                return;
            }

            // è·å–æ¨¡å‹è·¯å¾„
            let modelPath;
            const selectedMode = document.querySelector('input[name="model-mode"]:checked');
            if (!selectedMode) {
                alert('è¯·é€‰æ‹©æ¨¡å‹æ¨¡å¼');
                logMessage('error', 'æ²¡æœ‰é€‰æ‹©æ¨¡å‹æ¨¡å¼');
                return;
            }

            if (selectedMode.value === 'auto') {
                const modelSelector = document.getElementById('model-selector');
                if (!modelSelector) {
                    logMessage('error', 'æ‰¾ä¸åˆ°model-selectorå…ƒç´ ');
                    alert('é¡µé¢å…ƒç´ é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }
                modelPath = modelSelector.value;
            } else {
                const modelPathInput = document.getElementById('model-path');
                if (!modelPathInput) {
                    logMessage('error', 'æ‰¾ä¸åˆ°model-pathå…ƒç´ ');
                    alert('é¡µé¢å…ƒç´ é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }
                modelPath = modelPathInput.value;
            }

            if (!modelPath || modelPath.trim() === '') {
                alert('è¯·é€‰æ‹©æˆ–è¾“å…¥æ¨¡å‹è·¯å¾„');
                logMessage('error', 'æ¨¡å‹è·¯å¾„ä¸ºç©º');
                return;
            }

            // æ£€æŸ¥é‡åŒ–é€‰é¡¹
            const quantizationRadio = document.querySelector('input[name="quantization"]:checked');
            if (!quantizationRadio) {
                alert('è¯·é€‰æ‹©é‡åŒ–é€‰é¡¹');
                logMessage('error', 'æ²¡æœ‰é€‰æ‹©é‡åŒ–é€‰é¡¹');
                return;
            }
            const quantization = quantizationRadio.value;

            // è·å–è®­ç»ƒå‚æ•°
            const epochsInput = document.getElementById('epochs');
            const batchSizeInput = document.getElementById('batch-size');
            const learningRateInput = document.getElementById('learning-rate');

            if (!epochsInput || !batchSizeInput || !learningRateInput) {
                alert('é¡µé¢å…ƒç´ é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                logMessage('error', 'æ‰¾ä¸åˆ°è®­ç»ƒå‚æ•°è¾“å…¥å…ƒç´ ');
                return;
            }

            const epochs = epochsInput.value;
            const batchSize = batchSizeInput.value;
            const learningRate = learningRateInput.value;

            logMessage('info', `è®­ç»ƒå‚æ•°: æ¨¡å‹=${modelPath}, é‡åŒ–=${quantization}, epochs=${epochs}, batch_size=${batchSize}, lr=${learningRate}`);

            const formData = new FormData();
            formData.append('training_data', fileInput.files[0]);
            formData.append('model_path', modelPath); // æ·»åŠ æ¨¡å‹è·¯å¾„
            formData.append('epochs', epochs);
            formData.append('batch_size', batchSize);
            formData.append('learning_rate', learningRate);
            formData.append('use_4bit', quantization === '4bit' ? 'true' : 'false');
            formData.append('use_8bit', quantization === '8bit' ? 'true' : 'false');

            // ç¦ç”¨å¼€å§‹æŒ‰é’®
            const startBtn = document.getElementById('start-training-btn');
            if (startBtn) {
                startBtn.disabled = true;
                startBtn.textContent = 'ğŸš€ æ­£åœ¨å¯åŠ¨è®­ç»ƒ...';
            }

            logMessage('info', `å¼€å§‹${quantization}é‡åŒ–LoRAå¾®è°ƒï¼Œæ¨¡å‹è·¯å¾„: ${modelPath}`);

            try {
                logMessage('info', 'æ­£åœ¨å‘é€APIè¯·æ±‚...');
                const result = await callAPI('start_finetuning', 'POST', formData);
                
                logMessage('info', `APIå“åº”: ${JSON.stringify(result)}`);

                if (result.status === 'success') {
                    currentTrainingConfig = result.config || {};
                    logMessage('info', `${quantization}é‡åŒ–å¾®è°ƒå·²å¼€å§‹ï¼Œæ¨¡å‹å°†ä¿å­˜åˆ°: ${result.output_dir || 'æœªçŸ¥è·¯å¾„'}`);

                    // æ˜¾ç¤ºè®­ç»ƒè¯¦ç»†ä¿¡æ¯
                    const detailsDiv = document.getElementById('training-details');
                    if (detailsDiv) {
                        detailsDiv.style.display = 'block';
                        
                        const quantizationSpan = document.getElementById('training-quantization');
                        const batchSizeSpan = document.getElementById('training-batch-size');
                        
                        if (quantizationSpan) quantizationSpan.textContent = (result.config && result.config.quantization) || quantization;
                        if (batchSizeSpan) batchSizeSpan.textContent = (result.config && result.config.batch_size) || batchSize;
                    }

                    // å¼€å§‹æ›´æ–°è¿›åº¦
                    logMessage('info', 'å¼€å§‹ç›‘æ§è®­ç»ƒè¿›åº¦');
                    updateTrainingProgress();
                    
                    alert('è®­ç»ƒå·²å¼€å§‹ï¼è¯·æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—äº†è§£è¯¦ç»†è¿›åº¦ã€‚');
                } else {
                    logMessage('error', `å¾®è°ƒå¯åŠ¨å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                    alert('å¾®è°ƒå¯åŠ¨å¤±è´¥: ' + (result.message || JSON.stringify(result)));
                }
            } catch (error) {
                logMessage('error', `å¾®è°ƒå¯åŠ¨å‡ºé”™: ${error.message}`);
                console.error('å¾®è°ƒå¯åŠ¨è¯¦ç»†é”™è¯¯:', error);
                alert('å¾®è°ƒå¯åŠ¨å‡ºé”™: ' + error.message + '\nè¯·æ£€æŸ¥æ§åˆ¶å°å’Œç³»ç»Ÿæ—¥å¿—äº†è§£è¯¦æƒ…');
            } finally {
                // å»¶è¿Ÿæ¢å¤æŒ‰é’®çŠ¶æ€ï¼Œé¿å…ç”¨æˆ·é‡å¤ç‚¹å‡»
                setTimeout(() => {
                    if (startBtn) {
                        startBtn.disabled = false;
                        startBtn.textContent = 'ğŸš€ å¼€å§‹LoRAå¾®è°ƒ';
                    }
                }, 2000);
            }
        }

        // æ›´æ–°è®­ç»ƒè¿›åº¦
        async function updateTrainingProgress() {
            try {
                const result = await callAPI('training_progress');

                if (result.status === 'success') {
                    const progress = result.progress;

                    document.getElementById('training-progress').style.width = `${progress}%`;
                    document.getElementById('progress-text').textContent = `${progress}%`;

                    if (result.estimated_remaining_seconds) {
                        const remainingMinutes = Math.ceil(result.estimated_remaining_seconds / 60);
                        document.getElementById('training-remaining').textContent = `${remainingMinutes}åˆ†é’Ÿ`;
                    }

                    if (result.start_time) {
                        const startTime = new Date(result.start_time).toLocaleTimeString();
                        document.getElementById('progress-time').textContent = `å¼€å§‹æ—¶é—´: ${startTime}`;
                    }

                    if (progress < 100 && result.active) {
                        setTimeout(updateTrainingProgress, 2000);
                    } else if (progress >= 100) {
                        logMessage('info', `${currentTrainingConfig?.quantization || ''}é‡åŒ–LoRAå¾®è°ƒå®Œæˆ`);
                        setTimeout(() => {
                            document.getElementById('training-details').style.display = 'none';
                        }, 5000);
                        setTimeout(discoverModels, 1000); // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
                        alert(`${currentTrainingConfig?.quantization || ''}é‡åŒ–æ¨¡å‹è®­ç»ƒå®Œæˆï¼`);
                    } else if (result.error) {
                        logMessage('error', `è®­ç»ƒå¤±è´¥: ${result.error}`);
                        alert('è®­ç»ƒå¤±è´¥: ' + result.error);
                        document.getElementById('training-details').style.display = 'none';
                    }
                }
            } catch (error) {
                logMessage('error', `è·å–è®­ç»ƒè¿›åº¦å¤±è´¥: ${error.message}`);
            }
        }

        // ======= ç¬¬äºŒé¡µï¼šé—®ç­”ç›¸å…³å‡½æ•° =======

        // åŠ è½½èŠå¤©æ¨¡å‹
        async function loadChatModel() {
            const modelPath = document.getElementById('chat-model-selector').value;
            
            if (!modelPath) {
                alert('è¯·é€‰æ‹©è¦åŠ è½½çš„æ¨¡å‹');
                return;
            }

            const loadBtn = document.getElementById('load-chat-model-btn');
            loadBtn.disabled = true;
            loadBtn.textContent = 'ğŸ“¥ æ­£åœ¨åŠ è½½...';

            logMessage('info', `æ­£åœ¨åŠ è½½æ¨¡å‹: ${modelPath}`);

            try {
                const result = await callAPI('load_model', 'POST', {
                    model_path: modelPath,
                    use_4bit: true,
                    use_8bit: false
                });

                if (result.status === 'success') {
                    modelLoaded = true;
                    const quantization = result.quantization || 'unknown';
                    document.getElementById('model-status').textContent = `â— æ¨¡å‹å·²åŠ è½½ (${quantization})`;
                    document.getElementById('model-status').className = 'status-indicator status-online';
                    loadBtn.textContent = `âœ“ æ¨¡å‹å·²åŠ è½½ (${quantization})`;
                    logMessage('info', `æ¨¡å‹åŠ è½½æˆåŠŸï¼Œä½¿ç”¨${quantization}é‡åŒ–`);
                } else {
                    logMessage('error', `æ¨¡å‹åŠ è½½å¤±è´¥: ${result.message}`);
                    alert('æ¨¡å‹åŠ è½½å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                logMessage('error', `æ¨¡å‹åŠ è½½å‡ºé”™: ${error.message}`);
                alert('æ¨¡å‹åŠ è½½å‡ºé”™: ' + error.message);
            } finally {
                loadBtn.disabled = false;
                if (!modelLoaded) {
                    loadBtn.textContent = 'ğŸ“¥ åŠ è½½æ¨¡å‹';
                }
            }
        }

        // å¸è½½èŠå¤©æ¨¡å‹
        async function unloadChatModel() {
            const result = await callAPI('unload_model', 'POST');

            if (result.status === 'success') {
                modelLoaded = false;
                document.getElementById('model-status').textContent = 'â— æ¨¡å‹æœªåŠ è½½';
                document.getElementById('model-status').className = 'status-indicator status-offline';

                const loadBtn = document.getElementById('load-chat-model-btn');
                loadBtn.textContent = 'ğŸ“¥ åŠ è½½æ¨¡å‹';

                logMessage('info', 'æ¨¡å‹å·²å¸è½½');
            } else {
                logMessage('error', `æ¨¡å‹å¸è½½å¤±è´¥: ${result.message}`);
            }
        }

        // è¿æ¥Neo4j
        async function connectNeo4j() {
            const uri = document.getElementById('neo4j-uri').value;
            const user = document.getElementById('neo4j-user').value;
            const password = document.getElementById('neo4j-password').value;

            logMessage('info', 'æ­£åœ¨è¿æ¥Neo4jæ•°æ®åº“...');

            const result = await callAPI('connect_neo4j', 'POST', {
                uri: uri,
                user: user,
                password: password
            });

            if (result.status === 'success') {
                neo4jConnected = true;
                document.getElementById('neo4j-status').textContent = 'â— æ•°æ®åº“å·²è¿æ¥';
                document.getElementById('neo4j-status').className = 'status-indicator status-online';
                logMessage('info', 'Neo4jè¿æ¥æˆåŠŸ');
            } else {
                logMessage('error', `Neo4jè¿æ¥å¤±è´¥: ${result.message}`);
                alert('Neo4jè¿æ¥å¤±è´¥: ' + result.message);
            }
        }

        // æ–­å¼€Neo4jè¿æ¥
        async function disconnectNeo4j() {
            const result = await callAPI('disconnect_neo4j', 'POST');
            if (result.status === 'success') {
                neo4jConnected = false;
                document.getElementById('neo4j-status').textContent = 'â— æ•°æ®åº“æœªè¿æ¥';
                document.getElementById('neo4j-status').className = 'status-indicator status-offline';
                logMessage('info', 'Neo4jå·²æ–­å¼€è¿æ¥');
            }
        }

        // ç”Ÿæˆç¤ºä¾‹çŸ¥è¯†
        async function generateSampleKnowledge() {
            if (!neo4jConnected) {
                alert('è¯·å…ˆè¿æ¥Neo4jæ•°æ®åº“');
                return;
            }

            logMessage('info', 'æ­£åœ¨ç”Ÿæˆç¤ºä¾‹çŸ¥è¯†...');

            const result = await callAPI('generate_sample_knowledge', 'POST');

            if (result.status === 'success') {
                logMessage('info', 'ç¤ºä¾‹çŸ¥è¯†ç”ŸæˆæˆåŠŸ');
                alert('ç¤ºä¾‹çŸ¥è¯†ç”ŸæˆæˆåŠŸï¼ç°åœ¨å¯ä»¥å¼€å§‹æ™ºèƒ½é—®ç­”äº†ã€‚');
            } else {
                logMessage('error', `ç¤ºä¾‹çŸ¥è¯†ç”Ÿæˆå¤±è´¥: ${result.message}`);
                alert('ç¤ºä¾‹çŸ¥è¯†ç”Ÿæˆå¤±è´¥: ' + result.message);
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            if (!modelLoaded) {
                alert('è¯·å…ˆåŠ è½½æ¨¡å‹ï¼');
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©æ¡†
            const chatContainer = document.getElementById('chat-messages');
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message chat-user';
            userMsg.innerHTML = `<strong>ğŸ‘¤ ä½ :</strong> ${message}`;
            chatContainer.appendChild(userMsg);

            input.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // æ˜¾ç¤ºæ­£åœ¨æ€è€ƒçš„æ¶ˆæ¯
            const thinkingMsg = document.createElement('div');
            thinkingMsg.className = 'chat-message chat-assistant';
            thinkingMsg.innerHTML = '<strong>ğŸ¤– PEPPER:</strong> æ­£åœ¨æ€è€ƒä¸­...';
            chatContainer.appendChild(thinkingMsg);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                // å¦‚æœè¿æ¥äº†çŸ¥è¯†å›¾è°±ï¼Œä½¿ç”¨çŸ¥è¯†å¢å¼ºçš„é—®ç­”
                let result;
                if (neo4jConnected) {
                    result = await callAPI('chat', 'POST', {
                        message: message,
                        use_knowledge_graph: true
                    });
                } else {
                    // ä»…ä½¿ç”¨æ¨¡å‹è¿›è¡Œé—®ç­”
                    result = await callAPI('test_model', 'POST', {
                        question: message,
                        temperature: parseFloat(document.getElementById('temperature').value),
                        max_tokens: parseInt(document.getElementById('max-tokens').value)
                    });
                }

                // ç§»é™¤æ€è€ƒæ¶ˆæ¯
                chatContainer.removeChild(thinkingMsg);

                if (result.status === 'success') {
                    const assistantMsg = document.createElement('div');
                    assistantMsg.className = 'chat-message chat-assistant';
                    assistantMsg.innerHTML = `<strong>ğŸ¤– PEPPER:</strong> ${result.response || result.result}`;
                    chatContainer.appendChild(assistantMsg);
                } else {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'chat-message chat-assistant';
                    errorMsg.innerHTML = `<strong>ğŸ¤– PEPPER:</strong> æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„é—®é¢˜æ—¶å‡ºç°äº†é”™è¯¯ï¼š${result.message}`;
                    chatContainer.appendChild(errorMsg);
                }

                chatContainer.scrollTop = chatContainer.scrollHeight;
                logMessage('info', `é—®ç­”å®Œæˆ: ${message.substring(0, 50)}...`);

            } catch (error) {
                // ç§»é™¤æ€è€ƒæ¶ˆæ¯
                if (chatContainer.contains(thinkingMsg)) {
                    chatContainer.removeChild(thinkingMsg);
                }

                const errorMsg = document.createElement('div');
                errorMsg.className = 'chat-message chat-assistant';
                errorMsg.innerHTML = `<strong>ğŸ¤– PEPPER:</strong> è¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡è¯•ã€‚`;
                chatContainer.appendChild(errorMsg);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                logMessage('error', `å‘é€æ¶ˆæ¯å¤±è´¥: ${error.message}`);
            }
        }

        // æ¸…ç©ºå¯¹è¯
        function clearChat() {
            const chatContainer = document.getElementById('chat-messages');
            chatContainer.innerHTML = `
                <div class="chat-message chat-assistant">
                    <strong>ğŸ¤– PEPPER:</strong> å¯¹è¯å·²æ¸…ç©ºï¼Œè¯·ç»§ç»­æé—®ï¼
                </div>
            `;
            logMessage('info', 'å¯¹è¯å·²æ¸…ç©º');
        }

        // æµ‹è¯•æ¨¡å‹è¿æ¥
        async function testModelConnection() {
            if (!modelLoaded) {
                alert('è¯·å…ˆåŠ è½½æ¨¡å‹ï¼');
                return;
            }

            const testQuestions = [
                'Pythonä¸­forå¾ªç¯å’Œwhileå¾ªç¯æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ',
                'ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ',
                'ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±ã€‚'
            ];

            const randomQuestion = testQuestions[Math.floor(Math.random() * testQuestions.length)];
            
            document.getElementById('chat-input').value = randomQuestion;
            sendMessage();
        }

        // æ›´æ–°é¢„è®¡è®­ç»ƒæ—¶é—´
        function updateEstimatedTime() {
            const epochs = parseInt(document.getElementById('epochs').value);
            const batchSize = parseInt(document.getElementById('batch-size').value);
            const quantization = document.querySelector('input[name="quantization"]:checked').value;

            let baseTimePerEpoch = 5; // åˆ†é’Ÿ

            if (quantization === '4bit') {
                baseTimePerEpoch *= 1.2;
            } else if (quantization === '8bit') {
                baseTimePerEpoch *= 1.1;
            }

            baseTimePerEpoch *= (4 / batchSize);

            const totalMinutes = epochs * baseTimePerEpoch;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);

            let timeText = '';
            if (hours > 0) {
                timeText = `çº¦${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
            } else {
                timeText = `çº¦${minutes}åˆ†é’Ÿ`;
            }

            document.getElementById('estimated-time').textContent = timeText;
        }

        // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
        function setupEventListeners() {
            // å‚æ•°æ»‘å—æ›´æ–°
            const temperatureSlider = document.getElementById('temperature');
            if (temperatureSlider) {
                temperatureSlider.addEventListener('input', function(e) {
                    const tempValueSpan = document.getElementById('temp-value');
                    if (tempValueSpan) {
                        tempValueSpan.textContent = e.target.value;
                    }
                });
            }

            // å›è½¦å‘é€æ¶ˆæ¯
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            // ç›‘å¬å‚æ•°å˜åŒ–ï¼Œæ›´æ–°é¢„è®¡æ—¶é—´
            const epochsInput = document.getElementById('epochs');
            const batchSizeInput = document.getElementById('batch-size'); 
            
            if (epochsInput) {
                epochsInput.addEventListener('change', updateEstimatedTime);
            }
            if (batchSizeInput) {
                batchSizeInput.addEventListener('change', updateEstimatedTime);
            }
            
            document.querySelectorAll('input[name="quantization"]').forEach(radio => {
                radio.addEventListener('change', updateEstimatedTime);
            });

            // æ–‡ä»¶ä¸Šä¼ æ˜¾ç¤º
            const trainingDataInput = document.getElementById('training-data');
            if (trainingDataInput) {
                trainingDataInput.addEventListener('change', function(e) {
                    logMessage('info', 'æ–‡ä»¶ä¸Šä¼ äº‹ä»¶è§¦å‘');
                    const file = e.target.files[0];
                    if (file) {
                        const uploadDiv = document.querySelector('.file-upload');
                        if (uploadDiv) {
                            uploadDiv.innerHTML = `
                                <p>âœ… å·²é€‰æ‹©æ–‡ä»¶: ${file.name}</p>
                                <small>å¤§å°: ${(file.size / 1024).toFixed(2)} KB</small>
                            `;
                            uploadDiv.style.borderColor = '#2ed573';
                            uploadDiv.style.background = 'rgba(46, 213, 115, 0.1)';
                            logMessage('info', `å·²é€‰æ‹©è®­ç»ƒæ•°æ®æ–‡ä»¶: ${file.name} (${file.size} bytes)`);
                        }
                    }
                });
            } else {
                logMessage('error', 'æ‰¾ä¸åˆ°training-dataå…ƒç´ ï¼Œæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ');
            }

            // æ·»åŠ æ–‡ä»¶ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
            const fileUploadDiv = document.querySelector('.file-upload');
            if (fileUploadDiv && trainingDataInput) {
                fileUploadDiv.addEventListener('click', function() {
                    trainingDataInput.click();
                });
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('info', 'PEPPERæ™ºèƒ½æ•™å­¦ç³»ç»Ÿç•Œé¢åŠ è½½å®Œæˆ');
            
            // æ£€æŸ¥å…³é”®å…ƒç´ æ˜¯å¦å­˜åœ¨
            const criticalElements = [
                'training-data',
                'model-selector', 
                'model-path',
                'epochs',
                'batch-size',
                'learning-rate',
                'start-training-btn'
            ];
            
            let missingElements = [];
            criticalElements.forEach(id => {
                if (!document.getElementById(id)) {
                    missingElements.push(id);
                }
            });
            
            if (missingElements.length > 0) {
                logMessage('error', `ç¼ºå°‘å…³é”®å…ƒç´ : ${missingElements.join(', ')}`);
                alert(`é¡µé¢åŠ è½½ä¸å®Œæ•´ï¼Œç¼ºå°‘å…ƒç´ : ${missingElements.join(', ')}\nè¯·åˆ·æ–°é¡µé¢é‡è¯•`);
                return;
            }
            
            logMessage('info', 'æ‰€æœ‰å…³é”®å…ƒç´ æ£€æŸ¥é€šè¿‡');
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // è‡ªåŠ¨æ‰«ææ¨¡å‹
            setTimeout(() => {
                logMessage('info', 'å¼€å§‹è‡ªåŠ¨æ‰«ææ¨¡å‹');
                discoverModels();
            }, 2000);

            // æ£€æŸ¥é‡åŒ–æ”¯æŒ
            setTimeout(() => {
                logMessage('info', 'æ£€æŸ¥é‡åŒ–æ”¯æŒ');
                checkQuantizationSupport();
            }, 1000);

            // æ›´æ–°é¢„è®¡è®­ç»ƒæ—¶é—´
            updateEstimatedTime();
            
            logMessage('info', 'ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html></title>
</head>
<body>

</body>
</html>