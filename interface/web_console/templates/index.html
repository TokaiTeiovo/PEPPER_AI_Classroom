<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PEPPER智能教学系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            color: #2f3542;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: #f8f9ff;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .nav-tab:hover {
            background: #f8f9ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .panel h2 {
            color: #2f3542;
            margin-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #57606f;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #a4b0be;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #57606f;
        }

        .btn-success {
            background: #2ed573;
        }

        .btn-danger {
            background: #ff4757;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .status-online {
            background: #d4edcf;
            color: #2ed573;
        }

        .status-offline {
            background: #ffd3d8;
            color: #ff4757;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .chat-container {
            height: 400px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9ff;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 12px;
            max-width: 80%;
        }

        .chat-user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .chat-assistant {
            background: white;
            border: 1px solid #e1e5e9;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e1e5e9;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .file-upload {
            border: 2px dashed #e1e5e9;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .log-container {
            background: #2f3542;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .form-row {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PEPPER智能教学系统</h1>
            <p>基于DeepSeek模型的个性化AI教学助手</p>
        </div>

        <!-- 导航标签 -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('llm')">🧠 大语言模型</button>
            <button class="nav-tab" onclick="showTab('knowledge')">🗂️ 知识图谱</button>
            <button class="nav-tab" onclick="showTab('multimodal')">🎯 多模态交互</button>
            <button class="nav-tab" onclick="showTab('teaching')">📚 智能教学</button>
        </div>

        <!-- 大语言模型标签页 -->
        <div id="llm" class="tab-content active">
            <div class="grid-2">
                <div class="panel">
                    <h2>DeepSeek模型管理</h2>
                    <div class="form-group">
                        <label>模型状态</label>
                        <div class="status-indicator status-offline" id="model-status">
                            ● 模型未加载
                        </div>
                    </div>

                    <!-- 新增：模型发现和选择 -->
                    <div class="form-group">
                        <label>模型选择</label>

                        <!-- 模式切换标签 -->
                        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: nowrap;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal; white-space: nowrap;">
                                <input type="radio" name="model-mode" value="auto" checked onchange="toggleModelMode()" style="margin-right: 8px;">
                                <span>🎯 自动发现</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal; white-space: nowrap;">
                                <input type="radio" name="model-mode" value="manual" onchange="toggleModelMode()" style="margin-right: 8px;">
                                <span>✏️ 手动输入</span>
                            </label>
                        </div>

                        <!-- 自动发现模式 -->
                        <div id="auto-model-section">
                            <div class="model-selector-container">
                                <select id="model-selector" class="model-select">
                                    <option value="">🔍 选择一个模型...</option>
                                </select>
                                <button class="btn-scan" onclick="discoverModels()">
                                    <span class="scan-icon">🔄</span>
                                    <span class="scan-text">扫描</span>
                                </button>
                            </div>
                            <div id="model-scan-status" class="scan-status">
                                点击"扫描"来发现可用的模型
                            </div>
                        </div>

                        <!-- 手动输入模式 -->
                        <div id="manual-model-section" style="display: none;">
                            <input type="text" id="model-path" class="manual-path-input"
                                   value="models/deepseek-coder-1.3b-base"
                                   placeholder="输入模型路径，例如：models/deepseek-coder-1.3b-base">
                        </div>
                    </div>

                    <!-- 模型详细信息展示 -->
                    <div id="model-details" style="display: none; background: #f8f9ff; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <strong>模型信息</strong>
                                <ul id="model-basic-info" style="margin: 5px 0; padding-left: 20px;">
                                </ul>
                            </div>
                            <div>
                                <strong>文件统计</strong>
                                <ul id="model-file-stats" style="margin: 5px 0; padding-left: 20px;">
                                </ul>
                            </div>
                        </div>
                        <div style="margin-top: 10px;">
                            <strong>文件列表</strong>
                            <div id="model-files-list" style="max-height: 150px; overflow-y: auto; background: white; padding: 10px; border-radius: 4px; margin-top: 5px;">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button onclick="loadModel()" id="load-model-btn">加载模型</button>
                        <button class="btn-secondary" onclick="unloadModel()">卸载模型</button>
                        <button class="btn-secondary" onclick="showModelInfo()" id="info-model-btn">模型信息</button>
                    </div>

                    <h2>LoRA微调</h2>
                    <div class="form-group">
                        <label>训练数据文件</label>
                        <div class="file-upload" onclick="document.getElementById('training-data').click()">
                            <input type="file" id="training-data" accept=".json,.csv" style="display: none;">
                            <p>点击上传训练数据</p>
                            <small>支持JSON/CSV格式</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>训练轮数</label>
                            <input type="number" id="epochs" value="3" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label>学习率</label>
                            <input type="number" id="learning-rate" value="0.0002" step="0.0001">
                        </div>
                    </div>
                    <div class="form-group">
                        <button onclick="startFineTuning()">开始微调</button>
                    </div>
                    <div class="form-group">
                        <label>训练进度</label>
                        <div class="progress-bar">
                            <div class="progress-fill" id="training-progress" style="width: 0%"></div>
                        </div>
                        <span id="progress-text">0%</span>
                    </div>
                </div>

                <div class="panel">
                    <h2>模型测试</h2>
                    <div class="form-group">
                        <label>测试问题</label>
                        <textarea id="test-question" rows="3" placeholder="输入测试问题..."></textarea>
                    </div>
                    <div class="form-group">
                        <button onclick="testModel()">测试模型</button>
                    </div>
                    <div class="form-group">
                        <label>模型回答</label>
                        <div id="model-response" style="background: #f8f9ff; padding: 15px; border-radius: 8px; min-height: 100px;">
                            等待测试...
                        </div>
                    </div>

                    <h2>模型参数</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Temperature</label>
                            <input type="range" id="temperature" min="0.1" max="2.0" step="0.1" value="0.7">
                            <span id="temp-value">0.7</span>
                        </div>
                        <div class="form-group">
                            <label>Max Tokens</label>
                            <input type="number" id="max-tokens" value="512" min="50" max="2048">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 知识图谱标签页 -->
        <div id="knowledge" class="tab-content">
            <div class="grid-2">
                <div class="panel">
                    <h2>Neo4j数据库连接</h2>
                    <div class="form-group">
                        <label>连接状态</label>
                        <div class="status-indicator status-offline" id="neo4j-status">
                            ● 数据库未连接
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>服务器地址</label>
                            <input type="text" id="neo4j-uri" value="bolt://localhost:7687">
                        </div>
                        <div class="form-group">
                            <label>用户名</label>
                            <input type="text" id="neo4j-user" value="neo4j">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>密码</label>
                        <input type="password" id="neo4j-password" value="admin123">
                    </div>
                    <div class="form-group">
                        <button onclick="connectNeo4j()">连接数据库</button>
                        <button class="btn-secondary" onclick="disconnectNeo4j()">断开连接</button>
                    </div>

                    <h2>知识导入</h2>
                    <div class="form-group">
                        <label>知识文件</label>
                        <div class="file-upload" onclick="document.getElementById('knowledge-file').click()">
                            <input type="file" id="knowledge-file" accept=".json,.csv,.txt" style="display: none;">
                            <p>点击上传知识文件</p>
                            <small>支持JSON/CSV/TXT格式</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <button onclick="importKnowledge()">导入知识</button>
                        <button class="btn-success" onclick="generateSampleKnowledge()">生成示例知识</button>
                    </div>
                </div>

                <div class="panel">
                    <h2>知识查询</h2>
                    <div class="form-group">
                        <label>Cypher查询</label>
                        <textarea id="cypher-query" rows="4" placeholder="MATCH (n) RETURN n LIMIT 10"></textarea>
                    </div>
                    <div class="form-group">
                        <button onclick="executeCypher()">执行查询</button>
                        <button class="btn-secondary" onclick="clearResults()">清空结果</button>
                    </div>
                    <div class="form-group">
                        <label>查询结果</label>
                        <div id="query-results" style="background: #f8f9ff; padding: 15px; border-radius: 8px; height: 200px; overflow-y: auto;">
                            等待查询...
                        </div>
                    </div>

                    <h2>知识统计</h2>
                    <div class="grid-3">
                        <div class="card">
                            <h3>节点总数</h3>
                            <p id="node-count">--</p>
                        </div>
                        <div class="card">
                            <h3>关系总数</h3>
                            <p id="relation-count">--</p>
                        </div>
                        <div class="card">
                            <h3>知识域数</h3>
                            <p id="domain-count">--</p>
                        </div>
                    </div>
                    <button onclick="updateStats()">更新统计</button>
                </div>
            </div>
        </div>

        <!-- 多模态交互标签页 -->
        <div id="multimodal" class="tab-content">
            <div class="grid-3">
                <div class="panel">
                    <h2>语音识别</h2>
                    <div class="form-group">
                        <label>识别状态</label>
                        <div class="status-indicator status-offline" id="speech-status">
                            ● 语音识别未启动
                        </div>
                    </div>
                    <div class="form-group">
                        <label>音频文件</label>
                        <input type="file" id="audio-file" accept=".wav,.mp3,.m4a">
                    </div>
                    <div class="form-group">
                        <button onclick="startRecording()" id="record-btn">🎤 开始录音</button>
                        <button class="btn-secondary" onclick="uploadAudio()">上传音频</button>
                    </div>
                    <div class="form-group">
                        <label>识别结果</label>
                        <div id="speech-result" style="background: #f8f9ff; padding: 15px; border-radius: 8px; min-height: 80px;">
                            等待语音输入...
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2>图像识别</h2>
                    <div class="form-group">
                        <label>图像文件</label>
                        <div class="file-upload" onclick="document.getElementById('image-file').click()">
                            <input type="file" id="image-file" accept=".jpg,.jpeg,.png,.gif" style="display: none;">
                            <p>点击上传图像</p>
                            <small>支持JPG/PNG/GIF格式</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <img id="preview-image" style="max-width: 100%; max-height: 200px; display: none; border-radius: 8px;">
                    </div>
                    <div class="form-group">
                        <button onclick="recognizeImage()">识别图像</button>
                    </div>
                    <div class="form-group">
                        <label>识别结果</label>
                        <div id="image-result" style="background: #f8f9ff; padding: 15px; border-radius: 8px; min-height: 80px;">
                            等待图像上传...
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2>文本处理</h2>
                    <div class="form-group">
                        <label>输入文本</label>
                        <textarea id="text-input" rows="6" placeholder="输入要处理的文本..."></textarea>
                    </div>
                    <div class="form-group">
                        <button onclick="processText()">处理文本</button>
                        <button class="btn-secondary" onclick="extractKeywords()">提取关键词</button>
                    </div>
                    <div class="form-group">
                        <label>处理结果</label>
                        <div id="text-result" style="background: #f8f9ff; padding: 15px; border-radius: 8px; min-height: 100px;">
                            <div><strong>分词结果:</strong> <span id="tokens">--</span></div>
                            <div><strong>关键词:</strong> <span id="keywords">--</span></div>
                            <div><strong>问题类型:</strong> <span id="question-type">--</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 智能教学标签页 -->
        <div id="teaching" class="tab-content">
            <div class="grid-2">
                <div class="panel">
                    <h2>学生管理</h2>
                    <div class="form-group">
                        <label>选择学生</label>
                        <select id="student-select">
                            <option value="">选择学生...</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>学生姓名</label>
                            <input type="text" id="student-name" placeholder="输入学生姓名">
                        </div>
                        <div class="form-group">
                            <label>学习风格</label>
                            <select id="learning-style">
                                <option value="visual">视觉型</option>
                                <option value="auditory">听觉型</option>
                                <option value="reading">阅读型</option>
                                <option value="kinesthetic">动手型</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <button onclick="addStudent()">添加学生</button>
                        <button class="btn-secondary" onclick="loadStudentProfile()">加载档案</button>
                    </div>

                    <h2>学习路径生成</h2>
                    <div class="form-group">
                        <label>目标主题</label>
                        <input type="text" id="learning-goal" placeholder="例如：Python循环语句">
                    </div>
                    <div class="form-group">
                        <button onclick="generateLearningPath()">生成学习路径</button>
                    </div>
                    <div class="form-group">
                        <label>学习路径</label>
                        <div id="learning-path" style="background: #f8f9ff; padding: 15px; border-radius: 8px; min-height: 120px;">
                            等待生成学习路径...
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2>智能对话</h2>
                    <div class="chat-container" id="teaching-chat">
                        <div class="chat-message chat-assistant">
                            <strong>PEPPER:</strong> 你好！我是你的AI教学助手，有什么问题吗？
                        </div>
                    </div>
                    <div class="form-group" style="display: flex; gap: 10px; margin-top: 15px;">
                        <textarea id="chat-input" rows="2" placeholder="输入你的问题..." style="flex: 1;"></textarea>
                        <button onclick="sendMessage()" style="width: 80px;">发送</button>
                    </div>

                    <h2>资源推荐</h2>
                    <div class="form-group">
                        <label>推荐主题</label>
                        <select id="recommend-topic">
                            <option value="Python编程">Python编程</option>
                            <option value="人工智能">人工智能</option>
                            <option value="数学">数学</option>
                            <option value="物理">物理</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button onclick="getRecommendations()">获取推荐</button>
                    </div>
                    <div id="recommendations" style="background: #f8f9ff; padding: 15px; border-radius: 8px; min-height: 100px;">
                        等待推荐...
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>学习报告生成</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>报告类型</label>
                        <select id="report-type">
                            <option value="progress">学习进度报告</option>
                            <option value="performance">学习表现报告</option>
                            <option value="recommendation">学习建议报告</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>时间范围</label>
                        <select id="time-range">
                            <option value="week">近一周</option>
                            <option value="month">近一月</option>
                            <option value="semester">本学期</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <button onclick="generateReport()">生成报告</button>
                    <button class="btn-success" onclick="exportReport()">导出报告</button>
                </div>
                <div class="form-group">
                    <label>报告预览</label>
                    <div id="report-preview" style="background: #f8f9ff; padding: 20px; border-radius: 8px; min-height: 200px;">
                        等待生成报告...
                    </div>
                </div>
            </div>
        </div>

        <!-- 系统日志 -->
        <div class="panel">
            <h2>系统日志</h2>
            <div class="log-container" id="system-log">
                [系统] 等待操作...
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentStudent = null;
        let modelLoaded = false;
        let neo4jConnected = false;
        let isRecording = false;
        let discoveredModels = [];
        let selectedModelInfo = null;

        // 标签页切换
        function showTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // 移除所有标签按钮的激活状态
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // 显示选中的标签页
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            logMessage('info', `切换到${getTabName(tabName)}页面`);
        }

        function getTabName(tabName) {
            const names = {
                'llm': '大语言模型',
                'knowledge': '知识图谱',
                'multimodal': '多模态交互',
                'teaching': '智能教学'
            };
            return names[tabName] || tabName;
        }

        // 日志记录
        function logMessage(level, message) {
            const logContainer = document.getElementById('system-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${level.toUpperCase()}] ${message}\n`;
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // API调用函数
        async function callAPI(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    if (data instanceof FormData) {
                        delete options.headers['Content-Type'];
                        options.body = data;
                    } else {
                        options.body = JSON.stringify(data);
                    }
                }

                const response = await fetch(`/api/${endpoint}`, options);
                return await response.json();
            } catch (error) {
                logMessage('error', `API调用失败: ${error.message}`);
                return { status: 'error', message: error.message };
            }
        }

        // 发现可用模型
        async function discoverModels() {
            const scanBtn = document.querySelector('.btn-scan');
            const scanStatus = document.getElementById('model-scan-status');

            // 添加扫描动画
            scanBtn.classList.add('scanning');
            scanBtn.querySelector('.scan-text').textContent = '扫描中...';

            scanStatus.textContent = '🔍 正在扫描模型目录...';
            scanStatus.style.borderLeftColor = '#ff9f43';

            logMessage('info', '开始扫描模型目录');

            const result = await callAPI('discover_models');

            // 移除扫描动画
            scanBtn.classList.remove('scanning');
            scanBtn.querySelector('.scan-text').textContent = '扫描';

            if (result.status === 'success') {
                discoveredModels = result.models;
                updateModelSelector();

                const validCount = result.models.filter(m => m.valid).length;
                scanStatus.innerHTML = `✅ 发现 <strong>${result.count}</strong> 个模型目录，其中 <strong>${validCount}</strong> 个有效`;
                scanStatus.style.borderLeftColor = '#2ed573';

                logMessage('info', `模型扫描完成，发现 ${result.count} 个模型目录`);
            } else {
                scanStatus.innerHTML = `❌ 扫描失败: ${result.message}`;
                scanStatus.style.borderLeftColor = '#ff4757';
                logMessage('error', `模型扫描失败: ${result.message}`);
            }
        }

        // 更新模型选择器
        function updateModelSelector() {
            const selector = document.getElementById('model-selector');

            // 清空现有选项
            selector.innerHTML = '<option value="">🎯 选择一个模型...</option>';

            if (discoveredModels.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '😔 未发现任何模型';
                option.disabled = true;
                selector.appendChild(option);
                return;
            }

            // 添加发现的模型
            discoveredModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.path;

                // 设置显示文本和样式
                if (model.valid) {
                    option.textContent = `${model.display_name}`;
                    option.style.color = '#2f3542';
                } else {
                    option.textContent = `${model.display_name} (⚠️ 不完整)`;
                    option.style.color = '#ff6b7a';
                    option.style.fontStyle = 'italic';
                }

                selector.appendChild(option);
            });

            // 添加事件监听器
            selector.removeEventListener('change', onModelSelect); // 防止重复绑定
            selector.addEventListener('change', onModelSelect);
        }

        // 模型选择事件处理
        async function onModelSelect(event) {
            const selectedPath = event.target.value;
            const pathInput = document.getElementById('model-path');
            const detailsDiv = document.getElementById('model-details');
            const loadBtn = document.getElementById('load-model-btn');

            if (selectedPath) {
                // 更新路径输入框
                pathInput.value = selectedPath;

                // 显示模型详细信息
                await loadModelDetails(selectedPath);
                detailsDiv.style.display = 'block';

                // 确保按钮可见和可用
                loadBtn.style.display = 'inline-block';
                loadBtn.disabled = false;
                loadBtn.textContent = '加载模型';

                logMessage('info', `已选择模型: ${selectedPath}`);
            } else {
                // 隐藏详细信息
                detailsDiv.style.display = 'none';
                selectedModelInfo = null;
            }
        }

        // 加载模型详细信息
        async function loadModelDetails(modelPath) {
            const result = await callAPI('get_model_info', 'POST', { model_path: modelPath });

            if (result.status === 'success') {
                selectedModelInfo = result.model_info;
                displayModelDetails(selectedModelInfo);
            } else {
                logMessage('error', `获取模型信息失败: ${result.message}`);
            }
        }

        // 显示模型详细信息
        function displayModelDetails(modelInfo) {
            // 基本信息
            const basicInfo = document.getElementById('model-basic-info');
            basicInfo.innerHTML = `
                <li>名称: ${modelInfo.name}</li>
                <li>类型: ${modelInfo.model_type || '未知'}</li>
                <li>大小: ${modelInfo.total_size_display}</li>
                <li>词汇量: ${modelInfo.vocab_size ? modelInfo.vocab_size.toLocaleString() : '未知'}</li>
            `;

            // 文件统计
            const fileStats = document.getElementById('model-file-stats');
            const modelFiles = modelInfo.files.filter(f => f.type === 'model');
            const configFiles = modelInfo.config_files || [];
            const tokenizerFiles = modelInfo.tokenizer_files || [];

            fileStats.innerHTML = `
                <li>模型文件: ${modelFiles.length}</li>
                <li>配置文件: ${configFiles.length}</li>
                <li>分词器文件: ${tokenizerFiles.length}</li>
                <li>总文件数: ${modelInfo.files.length}</li>
            `;

            // 文件列表
            const filesList = document.getElementById('model-files-list');
            let filesHtml = '';

            // 按类型分组显示
            const filesByType = {
                'model': modelFiles,
                'config': configFiles,
                'tokenizer': tokenizerFiles,
                'other': modelInfo.files.filter(f => !['model', 'config', 'tokenizer'].includes(f.type))
            };

            Object.entries(filesByType).forEach(([type, files]) => {
                if (files.length > 0) {
                    const typeNames = {
                        'model': '🧠 模型文件',
                        'config': '⚙️ 配置文件',
                        'tokenizer': '📝 分词器文件',
                        'other': '📄 其他文件'
                    };

                    filesHtml += `<div style="margin-bottom: 10px;">
                        <strong>${typeNames[type]}:</strong><br>`;

                    files.forEach(file => {
                        const sizeText = file.size_mb ? `${file.size_mb} MB` : '未知大小';
                        filesHtml += `<div style="margin-left: 15px; font-size: 12px;">
                            ${file.name} (${sizeText})
                        </div>`;
                    });

                    filesHtml += '</div>';
                }
            });

            filesList.innerHTML = filesHtml || '无文件信息';
        }

        // 生成文件列表HTML
        function generateFilesList(files) {
            if (!files || files.length === 0) {
                return '<div style="text-align: center; color: #999; padding: 20px;">📭 无文件信息</div>';
            }

            // 按类型分组
            const filesByType = {
                'model': files.filter(f => f.type === 'model'),
                'config': files.filter(f => f.type === 'config'),
                'tokenizer': files.filter(f => f.type === 'tokenizer'),
                'other': files.filter(f => !['model', 'config', 'tokenizer'].includes(f.type))
            };

            const typeConfig = {
                'model': { icon: '🧠', name: '模型文件', color: '#667eea' },
                'config': { icon: '⚙️', name: '配置文件', color: '#2ed573' },
                'tokenizer': { icon: '📝', name: '分词器文件', color: '#ff9f43' },
                'other': { icon: '📄', name: '其他文件', color: '#a4b0be' }
            };

            let html = '';

            Object.entries(filesByType).forEach(([type, typeFiles]) => {
                if (typeFiles.length > 0) {
                    const config = typeConfig[type];
                    html += `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: ${config.color};">
                                <span>${config.icon}</span>
                                <span>${config.name} (${typeFiles.length})</span>
                            </div>
                            <div style="margin-left: 20px;">
                    `;

                    typeFiles.forEach(file => {
                        const sizeText = file.size_mb ? `${file.size_mb} MB` : '未知大小';
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; background: rgba(255,255,255,0.7); border-radius: 4px; margin-bottom: 4px; font-size: 12px;">
                                <span style="font-family: 'Courier New', monospace;">${file.name}</span>
                                <span style="color: #666; font-size: 11px;">${sizeText}</span>
                            </div>
                        `;
                    });

                    html += '</div></div>';
                }
            });

            return html || '<div style="text-align: center; color: #999; padding: 20px;">📭 无文件信息</div>';
        }

        // 切换模型模式
        function toggleModelMode() {
            const selectedMode = document.querySelector('input[name="model-mode"]:checked').value;
            const autoSection = document.getElementById('auto-model-section');
            const manualSection = document.getElementById('manual-model-section');
            const detailsDiv = document.getElementById('model-details');

            if (selectedMode === 'auto') {
                autoSection.style.display = 'block';
                manualSection.style.display = 'none';
                logMessage('info', '切换到自动发现模式');
            } else {
                autoSection.style.display = 'none';
                manualSection.style.display = 'block';
                detailsDiv.style.display = 'none';
                logMessage('info', '切换到手动输入模式');
            }
        }

        // 显示模型信息对话框
        function showModelInfo() {
            if (selectedModelInfo) {
                alert(`模型信息:\n名称: ${selectedModelInfo.name}\n路径: ${selectedModelInfo.path}\n大小: ${selectedModelInfo.total_size_display}\n文件数: ${selectedModelInfo.files.length}`);
            }
        }

        // 大语言模型功能
        async function loadModel() {
            let modelPath;

            if (document.getElementById('manual-path-toggle').checked) {
                modelPath = document.getElementById('model-path').value;
            } else {
                modelPath = document.getElementById('model-selector').value;
            }

            if (!modelPath) {
                alert('请选择或输入模型路径');
                return;
            }

            // 禁用按钮防止重复点击
            const loadBtn = document.getElementById('load-model-btn');
            loadBtn.disabled = true;
            loadBtn.textContent = '正在加载...';

            logMessage('info', `正在加载模型: ${modelPath}`);

            const result = await callAPI('load_model', 'POST', { model_path: modelPath });

            if (result.status === 'success') {
                modelLoaded = true;
                document.getElementById('model-status').textContent = '● 模型已加载';
                document.getElementById('model-status').className = 'status-indicator status-online';
                loadBtn.textContent = '✓ 模型已加载';
                loadBtn.style.backgroundColor = '#2ed573';
                logMessage('info', '模型加载成功');
            } else {
                // 加载失败，恢复按钮状态
                loadBtn.disabled = false;
                loadBtn.textContent = '加载模型';
                loadBtn.style.backgroundColor = '';
                logMessage('error', `模型加载失败: ${result.message}`);
                alert('模型加载失败: ' + result.message);
            }
        }

        async function unloadModel() {
            const result = await callAPI('unload_model', 'POST');

            if (result.status === 'success') {
                modelLoaded = false;
                document.getElementById('model-status').textContent = '● 模型未加载';
                document.getElementById('model-status').className = 'status-indicator status-offline';

                const loadBtn = document.getElementById('load-model-btn');
                loadBtn.textContent = '加载模型';
                loadBtn.disabled = false;
                loadBtn.style.backgroundColor = '';

                logMessage('info', '模型已卸载');
            } else {
                logMessage('error', `模型卸载失败: ${result.message}`);
            }
        }

        async function testModel() {
            if (!modelLoaded) {
                alert('请先加载模型');
                return;
            }

            const question = document.getElementById('test-question').value;
            if (!question.trim()) {
                alert('请输入测试问题');
                return;
            }

            logMessage('info', '正在测试模型...');

            const result = await callAPI('test_model', 'POST', {
                question: question,
                temperature: parseFloat(document.getElementById('temperature').value),
                max_tokens: parseInt(document.getElementById('max-tokens').value)
            });

            if (result.status === 'success') {
                document.getElementById('model-response').textContent = result.response;
                logMessage('info', '模型测试完成');
            } else {
                logMessage('error', `模型测试失败: ${result.message}`);
            }
        }

        async function startFineTuning() {
            const fileInput = document.getElementById('training-data');
            if (!fileInput.files[0]) {
                alert('请先上传训练数据');
                return;
            }

            const formData = new FormData();
            formData.append('training_data', fileInput.files[0]);
            formData.append('epochs', document.getElementById('epochs').value);
            formData.append('learning_rate', document.getElementById('learning-rate').value);

            logMessage('info', '开始LoRA微调...');

            const result = await callAPI('start_finetuning', 'POST', formData);

            if (result.status === 'success') {
                logMessage('info', 'LoRA微调已开始');
                updateTrainingProgress();
            } else {
                logMessage('error', `微调启动失败: ${result.message}`);
            }
        }

        async function updateTrainingProgress() {
            const result = await callAPI('training_progress');
            if (result.status === 'success') {
                const progress = result.progress;
                document.getElementById('training-progress').style.width = `${progress}%`;
                document.getElementById('progress-text').textContent = `${progress}%`;

                if (progress < 100) {
                    setTimeout(updateTrainingProgress, 2000);
                } else {
                    logMessage('info', 'LoRA微调完成');
                }
            }
        }

        // 知识图谱功能
        async function connectNeo4j() {
            const uri = document.getElementById('neo4j-uri').value;
            const user = document.getElementById('neo4j-user').value;
            const password = document.getElementById('neo4j-password').value;

            logMessage('info', '正在连接Neo4j数据库...');

            const result = await callAPI('connect_neo4j', 'POST', {
                uri: uri,
                user: user,
                password: password
            });

            if (result.status === 'success') {
                neo4jConnected = true;
                document.getElementById('neo4j-status').textContent = '● 数据库已连接';
                document.getElementById('neo4j-status').className = 'status-indicator status-online';
                logMessage('info', 'Neo4j连接成功');
                updateStats();
            } else {
                logMessage('error', `Neo4j连接失败: ${result.message}`);
            }
        }

        async function disconnectNeo4j() {
            const result = await callAPI('disconnect_neo4j', 'POST');
            if (result.status === 'success') {
                neo4jConnected = false;
                document.getElementById('neo4j-status').textContent = '● 数据库未连接';
                document.getElementById('neo4j-status').className = 'status-indicator status-offline';
                logMessage('info', 'Neo4j已断开连接');
            }
        }

        async function importKnowledge() {
            const fileInput = document.getElementById('knowledge-file');
            if (!fileInput.files[0]) {
                alert('请先选择知识文件');
                return;
            }

            const formData = new FormData();
            formData.append('knowledge_file', fileInput.files[0]);

            logMessage('info', '正在导入知识...');

            const result = await callAPI('import_knowledge', 'POST', formData);

            if (result.status === 'success') {
                logMessage('info', `知识导入成功，共导入${result.count}条知识`);
                updateStats();
            } else {
                logMessage('error', `知识导入失败: ${result.message}`);
            }
        }

        async function generateSampleKnowledge() {
            logMessage('info', '正在生成示例知识...');

            const result = await callAPI('generate_sample_knowledge', 'POST');

            if (result.status === 'success') {
                logMessage('info', '示例知识生成成功');
                updateStats();
            } else {
                logMessage('error', `示例知识生成失败: ${result.message}`);
            }
        }

        async function executeCypher() {
            if (!neo4jConnected) {
                alert('请先连接Neo4j数据库');
                return;
            }

            const query = document.getElementById('cypher-query').value;
            if (!query.trim()) {
                alert('请输入Cypher查询语句');
                return;
            }

            logMessage('info', '正在执行Cypher查询...');

            const result = await callAPI('execute_cypher', 'POST', { query: query });

            if (result.status === 'success') {
                document.getElementById('query-results').innerHTML =
                    '<pre>' + JSON.stringify(result.data, null, 2) + '</pre>';
                logMessage('info', `查询成功，返回${result.data.length}条结果`);
            } else {
                logMessage('error', `查询失败: ${result.message}`);
            }
        }

        function clearResults() {
            document.getElementById('query-results').textContent = '等待查询...';
        }

        async function updateStats() {
            if (!neo4jConnected) return;

            const result = await callAPI('get_graph_stats');

            if (result.status === 'success') {
                document.getElementById('node-count').textContent = result.stats.nodes;
                document.getElementById('relation-count').textContent = result.stats.relationships;
                document.getElementById('domain-count').textContent = result.stats.domains;
            }
        }

        // 多模态交互功能
        async function startRecording() {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    isRecording = true;
                    document.getElementById('record-btn').textContent = '🔴 停止录音';
                    document.getElementById('speech-status').textContent = '● 正在录音';
                    document.getElementById('speech-status').className = 'status-indicator status-online';
                    logMessage('info', '开始录音');

                    // 这里应该实现实际的录音逻辑

                } catch (error) {
                    logMessage('error', `录音失败: ${error.message}`);
                }
            } else {
                isRecording = false;
                document.getElementById('record-btn').textContent = '🎤 开始录音';
                document.getElementById('speech-status').textContent = '● 语音识别未启动';
                document.getElementById('speech-status').className = 'status-indicator status-offline';
                logMessage('info', '停止录音');
            }
        }

        async function uploadAudio() {
            const fileInput = document.getElementById('audio-file');
            if (!fileInput.files[0]) {
                alert('请先选择音频文件');
                return;
            }

            const formData = new FormData();
            formData.append('audio_file', fileInput.files[0]);

            logMessage('info', '正在识别语音...');

            const result = await callAPI('recognize_speech', 'POST', formData);

            if (result.status === 'success') {
                document.getElementById('speech-result').textContent = result.text;
                logMessage('info', '语音识别成功');
            } else {
                logMessage('error', `语音识别失败: ${result.message}`);
            }
        }

        async function recognizeImage() {
            const fileInput = document.getElementById('image-file');
            if (!fileInput.files[0]) {
                alert('请先选择图像文件');
                return;
            }

            const formData = new FormData();
            formData.append('image_file', fileInput.files[0]);

            logMessage('info', '正在识别图像...');

            const result = await callAPI('recognize_image', 'POST', formData);

            if (result.status === 'success') {
                document.getElementById('image-result').innerHTML =
                    `<strong>识别结果:</strong> ${result.result.class_name}<br>
                     <strong>置信度:</strong> ${(result.result.confidence * 100).toFixed(2)}%`;
                logMessage('info', '图像识别成功');
            } else {
                logMessage('error', `图像识别失败: ${result.message}`);
            }
        }

        async function processText() {
            const text = document.getElementById('text-input').value;
            if (!text.trim()) {
                alert('请输入要处理的文本');
                return;
            }

            logMessage('info', '正在处理文本...');

            const result = await callAPI('process_text', 'POST', { text: text });

            if (result.status === 'success') {
                document.getElementById('tokens').textContent = result.tokens.join(', ');
                document.getElementById('keywords').textContent = result.keywords.join(', ');
                document.getElementById('question-type').textContent = result.question_type;
                logMessage('info', '文本处理完成');
            } else {
                logMessage('error', `文本处理失败: ${result.message}`);
            }
        }

        async function extractKeywords() {
            const text = document.getElementById('text-input').value;
            if (!text.trim()) {
                alert('请输入要处理的文本');
                return;
            }

            const result = await callAPI('extract_keywords', 'POST', { text: text });

            if (result.status === 'success') {
                document.getElementById('keywords').textContent = result.keywords.join(', ');
                logMessage('info', '关键词提取完成');
            }
        }

        // 智能教学功能
        async function addStudent() {
            const name = document.getElementById('student-name').value;
            const learningStyle = document.getElementById('learning-style').value;

            if (!name.trim()) {
                alert('请输入学生姓名');
                return;
            }

            const result = await callAPI('add_student', 'POST', {
                name: name,
                learning_style: learningStyle
            });

            if (result.status === 'success') {
                const option = document.createElement('option');
                option.value = result.student_id;
                option.textContent = `${name} (${result.student_id})`;
                document.getElementById('student-select').appendChild(option);

                logMessage('info', `学生 ${name} 添加成功`);

                // 清空输入框
                document.getElementById('student-name').value = '';
            } else {
                logMessage('error', `添加学生失败: ${result.message}`);
            }
        }

        async function loadStudentProfile() {
            const studentId = document.getElementById('student-select').value;
            if (!studentId) {
                alert('请先选择学生');
                return;
            }

            const result = await callAPI('get_student_profile', 'POST', { student_id: studentId });

            if (result.status === 'success') {
                currentStudent = result.profile;
                logMessage('info', `加载学生档案: ${result.profile.name}`);
            }
        }

        async function generateLearningPath() {
            const studentId = document.getElementById('student-select').value;
            const goal = document.getElementById('learning-goal').value;

            if (!studentId || !goal.trim()) {
                alert('请选择学生并输入学习目标');
                return;
            }

            logMessage('info', '正在生成学习路径...');

            const result = await callAPI('generate_learning_path', 'POST', {
                student_id: studentId,
                goal: goal
            });

            if (result.status === 'success') {
                document.getElementById('learning-path').innerHTML =
                    result.learning_path.replace(/\n/g, '<br>');
                logMessage('info', '学习路径生成成功');
            } else {
                logMessage('error', `学习路径生成失败: ${result.message}`);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            // 添加用户消息到聊天框
            const chatContainer = document.getElementById('teaching-chat');
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message chat-user';
            userMsg.innerHTML = `<strong>你:</strong> ${message}`;
            chatContainer.appendChild(userMsg);

            input.value = '';

            // 发送到AI助手
            const result = await callAPI('chat', 'POST', {
                message: message,
                student_id: document.getElementById('student-select').value
            });

            if (result.status === 'success') {
                const assistantMsg = document.createElement('div');
                assistantMsg.className = 'chat-message chat-assistant';
                assistantMsg.innerHTML = `<strong>PEPPER:</strong> ${result.response}`;
                chatContainer.appendChild(assistantMsg);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        async function getRecommendations() {
            const topic = document.getElementById('recommend-topic').value;
            const studentId = document.getElementById('student-select').value;

            logMessage('info', '正在获取资源推荐...');

            const result = await callAPI('get_recommendations', 'POST', {
                topic: topic,
                student_id: studentId
            });

            if (result.status === 'success') {
                let html = '<h4>推荐资源:</h4><ul>';
                result.resources.forEach(resource => {
                    html += `<li><strong>${resource.title}</strong> (${resource.type})<br>
                            <small>${resource.description}</small></li>`;
                });
                html += '</ul>';
                document.getElementById('recommendations').innerHTML = html;
                logMessage('info', '资源推荐获取成功');
            }
        }

        async function generateReport() {
            const studentId = document.getElementById('student-select').value;
            const reportType = document.getElementById('report-type').value;
            const timeRange = document.getElementById('time-range').value;

            if (!studentId) {
                alert('请先选择学生');
                return;
            }

            logMessage('info', '正在生成学习报告...');

            const result = await callAPI('generate_report', 'POST', {
                student_id: studentId,
                report_type: reportType,
                time_range: timeRange
            });

            if (result.status === 'success') {
                document.getElementById('report-preview').innerHTML = result.report_html;
                logMessage('info', '学习报告生成成功');
            } else {
                logMessage('error', `报告生成失败: ${result.message}`);
            }
        }

        async function exportReport() {
            const reportContent = document.getElementById('report-preview').innerHTML;
            if (!reportContent || reportContent === '等待生成报告...') {
                alert('请先生成报告');
                return;
            }

            const result = await callAPI('export_report', 'POST', {
                content: reportContent,
                format: 'html'
            });

            if (result.status === 'success') {
                const link = document.createElement('a');
                link.href = result.download_url;
                link.download = result.filename;
                link.click();
                logMessage('info', '报告导出成功');
            }
        }

        // 文件上传预览
        document.getElementById('image-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('preview-image');
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // 参数滑块更新
        document.getElementById('temperature').addEventListener('input', function(e) {
            document.getElementById('temp-value').textContent = e.target.value;
        });

        // 回车发送消息
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                discoverModels();
            }, 3000);
            logMessage('info', '系统界面加载完成');
            // 加载学生列表
            callAPI('get_students').then(result => {
                if (result.status === 'success') {
                    const select = document.getElementById('student-select');
                    result.students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = `${student.name} (${student.id})`;
                        select.appendChild(option);
                    });
                }
            });
        });
    </script>
</body>
</html>