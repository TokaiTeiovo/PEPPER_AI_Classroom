<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PEPPERæ™ºèƒ½æ•™å­¦ç³»ç»Ÿ - å†…å­˜ç®¡ç†å¢å¼ºç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2f3542;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            color: #2f3542;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .nav-tab {
            flex: 1;
            padding: 20px 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 4px solid transparent;
            transition: all 0.3s ease;
            color: #57606f;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-color: #ffffff;
        }

        .nav-tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }

        .panel h2 {
            color: #2f3542;
            margin-bottom: 25px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            font-size: 1.5em;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .memory-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .memory-card h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .memory-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .memory-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .memory-bar-fill {
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            transition: width 0.3s ease;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #57606f;
            font-size: 14px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #a4b0be;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9f43, #ff7675);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #ff6b7a);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-online {
            background: linear-gradient(135deg, #2ed573, #17d0aa);
            color: white;
        }

        .status-offline {
            background: linear-gradient(135deg, #ff4757, #ff6b7a);
            color: white;
        }

        .quantization-options {
            margin-bottom: 20px;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-option {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .radio-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .radio-option input[type="radio"] {
            margin-right: 12px;
            margin-top: 2px;
            width: auto;
        }

        .radio-option:has(input:checked) {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .radio-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .radio-label strong {
            font-size: 15px;
            color: #2f3542;
        }

        .radio-label small {
            color: #666;
            font-size: 12px;
        }

        .file-upload {
            border: 3px dashed #e1e5e9;
            border-radius: 12px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.5);
        }

        .file-upload:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e1e5e9;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            border-radius: 15px;
        }

        .progress-container {
            position: relative;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 13px;
            color: #666;
        }

        .model-selector-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .model-select {
            flex: 1;
        }

        .btn-scan {
            padding: 15px 20px;
            white-space: nowrap;
        }

        .scan-status {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            font-size: 13px;
            border-left: 4px solid #667eea;
        }

        .chat-container {
            height: 400px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(248, 249, 255, 0.8);
            backdrop-filter: blur(5px);
        }

        .chat-message {
            margin-bottom: 18px;
            padding: 15px;
            border-radius: 15px;
            max-width: 85%;
            word-wrap: break-word;
        }

        .chat-user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .chat-assistant {
            background: white;
            border: 1px solid #e1e5e9;
            color: #2f3542;
            border-bottom-left-radius: 5px;
        }

        .log-container {
            background: #2f3542;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 20px;
            border-radius: 12px;
            height: 300px;
            overflow-y: auto;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
        }

        .alert-info {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid #667eea;
            color: #667eea;
        }

        .alert-warning {
            background: rgba(255, 159, 67, 0.1);
            border: 1px solid #ff9f43;
            color: #ff9f43;
        }

        .alert-success {
            background: rgba(46, 213, 115, 0.1);
            border: 1px solid #2ed573;
            color: #2ed573;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .model-selector-container {
                flex-direction: column;
            }

            .btn-scan {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– PEPPERæ™ºèƒ½æ•™å­¦ç³»ç»Ÿ</h1>
            <p>å†…å­˜ç®¡ç†ä¸è‡ªåŠ¨æ¸…ç†å¢å¼ºç‰ˆ</p>
        </div>

        <!-- å¯¼èˆªæ ‡ç­¾ -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('memory')">ğŸ§  å†…å­˜ç›‘æ§</button>
            <button class="nav-tab" onclick="showTab('training')">ğŸ¯ æ¨¡å‹è®­ç»ƒ</button>
            <button class="nav-tab" onclick="showTab('chat')">ğŸ’¬ æ™ºèƒ½é—®ç­”</button>
        </div>

        <!-- å†…å­˜ç›‘æ§æ ‡ç­¾é¡µ -->
        <div id="memory" class="tab-content active">
            <!-- ç³»ç»Ÿå†…å­˜çŠ¶æ€ -->
            <div class="panel">
                <h2>ğŸ’¾ ç³»ç»Ÿå†…å­˜çŠ¶æ€</h2>
                <div class="grid-3">
                    <div class="memory-card">
                        <h3>CPU å†…å­˜</h3>
                        <div class="memory-value" id="cpu-memory-used">--</div>
                        <div style="font-size: 0.9em;" id="cpu-memory-total">æ€»è®¡: -- GB</div>
                        <div class="memory-bar">
                            <div class="memory-bar-fill" id="cpu-memory-bar"></div>
                        </div>
                    </div>

                    <div class="memory-card">
                        <h3>GPU å†…å­˜</h3>
                        <div class="memory-value" id="gpu-memory-used">--</div>
                        <div style="font-size: 0.9em;" id="gpu-memory-total">æ€»è®¡: -- GB</div>
                        <div class="memory-bar">
                            <div class="memory-bar-fill" id="gpu-memory-bar"></div>
                        </div>
                    </div>

                    <div class="memory-card">
                        <h3>æ¨¡å‹çŠ¶æ€</h3>
                        <div style="font-size: 1.2em;" id="model-status-text">æ— æ¨¡å‹</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">
                            <div id="inference-status">æ¨ç†: æœªåŠ è½½</div>
                            <div id="training-status">è®­ç»ƒ: æœªè¿›è¡Œ</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button onclick="refreshMemoryInfo()">ğŸ”„ åˆ·æ–°å†…å­˜ä¿¡æ¯</button>
                    <button onclick="forceGarbageCollection()" class="btn-warning">ğŸ—‘ï¸ å¼ºåˆ¶åƒåœ¾å›æ”¶</button>
                </div>
            </div>

            <!-- è‡ªåŠ¨æ¸…ç†è®¾ç½® -->
            <div class="panel">
                <h2>âš™ï¸ è‡ªåŠ¨æ¸…ç†è®¾ç½®</h2>

                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label style="margin: 0;">è®­ç»ƒå®Œæˆåè‡ªåŠ¨æ¸…ç†æ¨¡å‹å†…å­˜</label>
                        <label class="switch">
                            <input type="checkbox" id="auto-cleanup-switch" checked onchange="toggleAutoCleanup()">
                            <span class="slider"></span>
                        </label>
                        <span id="auto-cleanup-status" style="color: #2ed573; font-weight: 600;">å·²å¯ç”¨</span>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>ğŸ’¡ è¯´æ˜ï¼š</strong><br>
                    â€¢ å¯ç”¨åï¼Œè®­ç»ƒå®Œæˆä¼šè‡ªåŠ¨æ¸…ç†è®­ç»ƒæ¨¡å‹ï¼Œé‡Šæ”¾å†…å­˜<br>
                    â€¢ æ¨ç†æ¨¡å‹ä¸å—å½±å“ï¼Œå¯ä»¥ç»§ç»­æ­£å¸¸ä½¿ç”¨<br>
                    â€¢ ç¦ç”¨åéœ€è¦æ‰‹åŠ¨æ¸…ç†å†…å­˜
                </div>

                <div class="form-group">
                    <button onclick="manualCleanup()" class="btn-danger">ğŸ§¹ æ‰‹åŠ¨æ¸…ç†æ‰€æœ‰æ¨¡å‹</button>
                    <button onclick="showMemoryTips()">ğŸ’¡ å†…å­˜ä¼˜åŒ–å»ºè®®</button>
                </div>
            </div>

            <!-- å†…å­˜ä½¿ç”¨è¯¦æƒ… -->
            <div class="panel">
                <h2>ğŸ“Š å†…å­˜ä½¿ç”¨è¯¦æƒ…</h2>
                <div id="memory-details">
                    <div class="alert alert-info">
                        ç‚¹å‡»"åˆ·æ–°å†…å­˜ä¿¡æ¯"è·å–è¯¦ç»†å†…å­˜ä½¿ç”¨æƒ…å†µ
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¨¡å‹è®­ç»ƒæ ‡ç­¾é¡µ -->
        <div id="training" class="tab-content">
            <div class="grid-2">
                <div class="panel">
                    <h2>ğŸ¯ LoRAè®­ç»ƒ</h2>

                    <div class="form-group">
                        <label>è®­ç»ƒçŠ¶æ€</label>
                        <div class="status-indicator status-offline" id="training-status-indicator">
                            â— æœªå¼€å§‹è®­ç»ƒ
                        </div>
                    </div>

                    <div class="form-group">
                        <label>è®­ç»ƒè¿›åº¦</label>
                        <div class="progress-bar">
                            <div class="progress-fill" id="training-progress" style="width: 0%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 13px; color: #666;">
                            <span id="progress-text">0%</span>
                            <span id="progress-time"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <div id="training-info" class="alert alert-info" style="display: none;">
                            <div><strong>æ¨¡å‹è·¯å¾„:</strong> <span id="training-model-path">-</span></div>
                            <div><strong>é‡åŒ–æ–¹å¼:</strong> <span id="training-quantization">-</span></div>
                            <div><strong>é¢„è®¡å‰©ä½™:</strong> <span id="training-remaining">-</span></div>
                            <div><strong>è‡ªåŠ¨æ¸…ç†:</strong> <span id="training-auto-cleanup">-</span></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button onclick="checkTrainingStatus()">ğŸ“Š æ£€æŸ¥è®­ç»ƒçŠ¶æ€</button>
                        <button onclick="stopTraining()" class="btn-danger" disabled id="stop-training-btn">ğŸ›‘ åœæ­¢è®­ç»ƒ</button>
                    </div>
                </div>

                <div class="panel">
                    <h2>ğŸ“ˆ è®­ç»ƒç›‘æ§</h2>

                    <div id="training-monitor">
                        <div class="alert alert-info">
                            è®­ç»ƒå¼€å§‹åå°†æ˜¾ç¤ºè¯¦ç»†ç›‘æ§ä¿¡æ¯
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å†…å­˜ç›‘æ§ï¼ˆè®­ç»ƒæœŸé—´ï¼‰</label>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <div style="flex: 1; text-align: center; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                                <div style="font-size: 0.9em; color: #666;">GPUä½¿ç”¨</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="training-gpu-usage">--%</div>
                            </div>
                            <div style="flex: 1; text-align: center; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                                <div style="font-size: 0.9em; color: #666;">é¢„è®¡å®Œæˆ</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="training-eta">--:--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ™ºèƒ½é—®ç­”æ ‡ç­¾é¡µ -->
        <div id="chat" class="tab-content">
            <div class="grid-2">
                <div class="panel">
                    <h2>ğŸ¤– æ¨¡å‹åŠ è½½</h2>

                    <div class="form-group">
                        <label>æ¨ç†æ¨¡å‹çŠ¶æ€</label>
                        <div class="status-indicator status-offline" id="inference-model-status">
                            â— æ¨¡å‹æœªåŠ è½½
                        </div>
                    </div>

                    <div class="form-group">
                        <button onclick="loadInferenceModel()" id="load-inference-btn">ğŸ“¥ åŠ è½½æ¨ç†æ¨¡å‹</button>
                        <button onclick="unloadInferenceModel()" class="btn-warning">ğŸ“¤ å¸è½½æ¨ç†æ¨¡å‹</button>
                    </div>

                    <div class="alert alert-warning">
                        <strong>âš ï¸ æ³¨æ„ï¼š</strong><br>
                        è®­ç»ƒæœŸé—´æ¨ç†æ¨¡å‹ä¼šè¢«è‡ªåŠ¨å¸è½½ä»¥èŠ‚çœå†…å­˜ã€‚<br>
                        è®­ç»ƒå®Œæˆåå¯é‡æ–°åŠ è½½è¿›è¡Œæ¨ç†ã€‚
                    </div>
                </div>

                <div class="panel">
                    <h2>ğŸ’¬ æ¨¡å‹æµ‹è¯•</h2>

                    <div class="form-group">
                        <label>æµ‹è¯•é—®é¢˜</label>
                        <textarea id="test-question" rows="3" placeholder="è¾“å…¥æµ‹è¯•é—®é¢˜..." style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px;"></textarea>
                    </div>

                    <div class="form-group">
                        <button onclick="testModel()">ğŸ§ª æµ‹è¯•æ¨¡å‹</button>
                    </div>

                    <div class="form-group">
                        <label>æ¨¡å‹å›ç­”</label>
                        <div id="model-response" style="background: rgba(248, 249, 255, 0.8); padding: 15px; border-radius: 8px; min-height: 100px;">
                            ç­‰å¾…æµ‹è¯•...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿæ—¥å¿— -->
        <div class="panel">
            <h2>ğŸ“ ç³»ç»Ÿæ—¥å¿—ä¸çŠ¶æ€</h2>
            <div class="log-container" id="system-log">
                [ç³»ç»Ÿ] PEPPERæ™ºèƒ½æ•™å­¦ç³»ç»Ÿå·²å¯åŠ¨ï¼Œå†…å­˜ç®¡ç†åŠŸèƒ½å·²å¯ç”¨
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let memoryRefreshInterval = null;
        let trainingMonitorInterval = null;
        let autoCleanupEnabled = true;

        // æ—¥å¿—è®°å½•
        function logMessage(level, message) {
            const logContainer = document.getElementById('system-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${level.toUpperCase()}] ${message}\n`;
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            logMessage('info', `åˆ‡æ¢åˆ°${getTabName(tabName)}é¡µé¢`);

            // å¦‚æœåˆ‡æ¢åˆ°å†…å­˜ç›‘æ§é¡µé¢ï¼Œè‡ªåŠ¨åˆ·æ–°å†…å­˜ä¿¡æ¯
            if (tabName === 'memory') {
                refreshMemoryInfo();
                startMemoryMonitoring();
            } else {
                stopMemoryMonitoring();
            }
        }

        function getTabName(tabName) {
            const names = {
                'memory': 'å†…å­˜ç›‘æ§',
                'training': 'æ¨¡å‹è®­ç»ƒ',
                'chat': 'æ™ºèƒ½é—®ç­”'
            };
            return names[tabName] || tabName;
        }

        // APIè°ƒç”¨å‡½æ•°
        async function callAPI(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    if (data instanceof FormData) {
                        delete options.headers['Content-Type'];
                        options.body = data;
                    } else {
                        options.body = JSON.stringify(data);
                    }
                }

                const response = await fetch(`/api/${endpoint}`, options);
                return await response.json();
            } catch (error) {
                logMessage('error', `APIè°ƒç”¨å¤±è´¥: ${error.message}`);
                return { status: 'error', message: error.message };
            }
        }

        // ======================== å†…å­˜ç›‘æ§åŠŸèƒ½ ========================

        // åˆ·æ–°å†…å­˜ä¿¡æ¯
        async function refreshMemoryInfo() {
            try {
                const result = await callAPI('system_memory_info');

                if (result.status === 'success') {
                    const memoryInfo = result.memory_info;

                    // æ›´æ–°CPUå†…å­˜
                    if (memoryInfo.cpu_memory) {
                        const cpu = memoryInfo.cpu_memory;
                        document.getElementById('cpu-memory-used').textContent = `${cpu.used_gb} GB`;
                        document.getElementById('cpu-memory-total').textContent = `æ€»è®¡: ${cpu.total_gb} GB`;
                        document.getElementById('cpu-memory-bar').style.width = `${cpu.percent}%`;
                    }

                    // æ›´æ–°GPUå†…å­˜
                    if (memoryInfo.gpu_memory && memoryInfo.gpu_memory.available !== false) {
                        const gpu = memoryInfo.gpu_memory;
                        document.getElementById('gpu-memory-used').textContent = `${gpu.cached_gb} GB`;
                        document.getElementById('gpu-memory-total').textContent = `æ€»è®¡: ${gpu.total_gb} GB`;
                        const gpuPercent = (gpu.cached_gb / gpu.total_gb) * 100;
                        document.getElementById('gpu-memory-bar').style.width = `${gpuPercent}%`;
                    } else {
                        document.getElementById('gpu-memory-used').textContent = 'ä¸å¯ç”¨';
                        document.getElementById('gpu-memory-total').textContent = 'æ— GPU';
                        document.getElementById('gpu-memory-bar').style.width = '0%';
                    }

                    // æ›´æ–°æ¨¡å‹çŠ¶æ€
                    if (memoryInfo.model_status) {
                        const status = memoryInfo.model_status;
                        let statusText = '';

                        if (status.inference_model_loaded && status.training_model_loaded) {
                            statusText = 'åŒæ¨¡å‹';
                        } else if (status.inference_model_loaded) {
                            statusText = 'æ¨ç†æ¨¡å‹';
                        } else if (status.training_model_loaded) {
                            statusText = 'è®­ç»ƒæ¨¡å‹';
                        } else {
                            statusText = 'æ— æ¨¡å‹';
                        }

                        document.getElementById('model-status-text').textContent = statusText;
                        document.getElementById('inference-status').textContent =
                            `æ¨ç†: ${status.inference_model_loaded ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}`;
                        document.getElementById('training-status').textContent =
                            `è®­ç»ƒ: ${status.training_active ? 'è¿›è¡Œä¸­' : 'æœªè¿›è¡Œ'}`;
                    }

                    // æ›´æ–°è¯¦ç»†ä¿¡æ¯
                    updateMemoryDetails(memoryInfo);

                    logMessage('info', 'å†…å­˜ä¿¡æ¯å·²åˆ·æ–°');
                } else {
                    logMessage('error', `è·å–å†…å­˜ä¿¡æ¯å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                logMessage('error', `åˆ·æ–°å†…å­˜ä¿¡æ¯å¤±è´¥: ${error.message}`);
            }
        }

        // æ›´æ–°å†…å­˜è¯¦æƒ…æ˜¾ç¤º
        function updateMemoryDetails(memoryInfo) {
            const detailsDiv = document.getElementById('memory-details');

            let html = '<div class="grid-2" style="gap: 15px;">';

            // CPUå†…å­˜è¯¦æƒ…
            if (memoryInfo.cpu_memory) {
                const cpu = memoryInfo.cpu_memory;
                html += `
                    <div style="padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">ğŸ’» CPUå†…å­˜</h4>
                        <div>æ€»å†…å­˜: ${cpu.total_gb} GB</div>
                        <div>å·²ä½¿ç”¨: ${cpu.used_gb} GB (${cpu.percent}%)</div>
                        <div>å¯ç”¨: ${cpu.available_gb} GB</div>
                    </div>
                `;
            }

            // GPUå†…å­˜è¯¦æƒ…
            if (memoryInfo.gpu_memory && memoryInfo.gpu_memory.available !== false) {
                const gpu = memoryInfo.gpu_memory;
                html += `
                    <div style="padding: 15px; background: rgba(46, 213, 115, 0.05); border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; color: #2ed573;">ğŸ® GPUå†…å­˜</h4>
                        <div>æ€»æ˜¾å­˜: ${gpu.total_gb} GB</div>
                        <div>å·²åˆ†é…: ${gpu.allocated_gb} GB</div>
                        <div>å·²ç¼“å­˜: ${gpu.cached_gb} GB</div>
                        <div>å¯ç”¨: ${gpu.free_gb} GB</div>
                    </div>
                `;
            } else {
                html += `
                    <div style="padding: 15px; background: rgba(255, 159, 67, 0.05); border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; color: #ff9f43;">ğŸ® GPUå†…å­˜</h4>
                        <div>GPUä¸å¯ç”¨æˆ–æœªæ£€æµ‹åˆ°CUDAè®¾å¤‡</div>
                    </div>
                `;
            }

            html += '</div>';
            detailsDiv.innerHTML = html;
        }

        // å¼€å§‹å†…å­˜ç›‘æ§
        function startMemoryMonitoring() {
            if (memoryRefreshInterval) {
                clearInterval(memoryRefreshInterval);
            }

            memoryRefreshInterval = setInterval(() => {
                refreshMemoryInfo();
            }, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡

            logMessage('info', 'å†…å­˜ç›‘æ§å·²å¯åŠ¨ï¼ˆæ¯5ç§’åˆ·æ–°ï¼‰');
        }

        // åœæ­¢å†…å­˜ç›‘æ§
        function stopMemoryMonitoring() {
            if (memoryRefreshInterval) {
                clearInterval(memoryRefreshInterval);
                memoryRefreshInterval = null;
                logMessage('info', 'å†…å­˜ç›‘æ§å·²åœæ­¢');
            }
        }

        // å¼ºåˆ¶åƒåœ¾å›æ”¶
        async function forceGarbageCollection() {
            try {
                logMessage('info', 'æ‰§è¡Œå¼ºåˆ¶åƒåœ¾å›æ”¶...');
                const result = await callAPI('manual_cleanup', 'POST');

                if (result.status === 'success') {
                    logMessage('success', `åƒåœ¾å›æ”¶å®Œæˆ: ${result.details.join(', ')}`);
                    alert(`åƒåœ¾å›æ”¶å®Œæˆï¼\n\n${result.details.join('\n')}`);

                    // åˆ·æ–°å†…å­˜ä¿¡æ¯
                    setTimeout(refreshMemoryInfo, 1000);
                } else {
                    logMessage('error', `åƒåœ¾å›æ”¶å¤±è´¥: ${result.message}`);
                    alert(`åƒåœ¾å›æ”¶å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                logMessage('error', `åƒåœ¾å›æ”¶å‡ºé”™: ${error.message}`);
                alert(`åƒåœ¾å›æ”¶å‡ºé”™: ${error.message}`);
            }
        }

        // åˆ‡æ¢è‡ªåŠ¨æ¸…ç†
        async function toggleAutoCleanup() {
            const switchElement = document.getElementById('auto-cleanup-switch');
            const statusElement = document.getElementById('auto-cleanup-status');

            const enabled = switchElement.checked;

            try {
                const result = await callAPI('toggle_auto_cleanup', 'POST', { enabled: enabled });

                if (result.status === 'success') {
                    autoCleanupEnabled = enabled;
                    statusElement.textContent = enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
                    statusElement.style.color = enabled ? '#2ed573' : '#ff4757';

                    logMessage('info', `è‡ªåŠ¨æ¸…ç†åŠŸèƒ½å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
                } else {
                    // æ¢å¤å¼€å…³çŠ¶æ€
                    switchElement.checked = !enabled;
                    logMessage('error', `åˆ‡æ¢è‡ªåŠ¨æ¸…ç†å¤±è´¥: ${result.message}`);
                    alert(`åˆ‡æ¢è‡ªåŠ¨æ¸…ç†å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                // æ¢å¤å¼€å…³çŠ¶æ€
                switchElement.checked = !enabled;
                logMessage('error', `åˆ‡æ¢è‡ªåŠ¨æ¸…ç†å‡ºé”™: ${error.message}`);
                alert(`åˆ‡æ¢è‡ªåŠ¨æ¸…ç†å‡ºé”™: ${error.message}`);
            }
        }

        // æ‰‹åŠ¨æ¸…ç†
        async function manualCleanup() {
            const confirm = window.confirm(
                'âš ï¸ ç¡®è®¤æ‰‹åŠ¨æ¸…ç†æ‰€æœ‰æ¨¡å‹ï¼Ÿ\n\n' +
                'è¿™å°†æ¸…ç†ï¼š\n' +
                'â€¢ æ¨ç†æ¨¡å‹ï¼ˆå¦‚å·²åŠ è½½ï¼‰\n' +
                'â€¢ è®­ç»ƒæ¨¡å‹ï¼ˆå¦‚å­˜åœ¨ï¼‰\n' +
                'â€¢ GPUç¼“å­˜\n\n' +
                'æ¸…ç†åéœ€è¦é‡æ–°åŠ è½½æ¨¡å‹æ‰èƒ½ä½¿ç”¨ã€‚'
            );

            if (!confirm) return;

            try {
                logMessage('info', 'å¼€å§‹æ‰‹åŠ¨æ¸…ç†æ‰€æœ‰æ¨¡å‹...');
                const result = await callAPI('manual_cleanup', 'POST');

                if (result.status === 'success') {
                    logMessage('success', `æ‰‹åŠ¨æ¸…ç†å®Œæˆ: ${result.details.join(', ')}`);
                    alert(`âœ… æ‰‹åŠ¨æ¸…ç†å®Œæˆï¼\n\næ¸…ç†å†…å®¹ï¼š\n${result.details.join('\n')}`);

                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    document.getElementById('inference-model-status').textContent = 'â— æ¨¡å‹æœªåŠ è½½';
                    document.getElementById('inference-model-status').className = 'status-indicator status-offline';

                    // åˆ·æ–°å†…å­˜ä¿¡æ¯
                    setTimeout(refreshMemoryInfo, 1000);
                } else {
                    logMessage('error', `æ‰‹åŠ¨æ¸…ç†å¤±è´¥: ${result.message}`);
                    alert(`âŒ æ‰‹åŠ¨æ¸…ç†å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                logMessage('error', `æ‰‹åŠ¨æ¸…ç†å‡ºé”™: ${error.message}`);
                alert(`âŒ æ‰‹åŠ¨æ¸…ç†å‡ºé”™: ${error.message}`);
            }
        }

        // æ˜¾ç¤ºå†…å­˜ä¼˜åŒ–å»ºè®®
        function showMemoryTips() {
            const tips = `
ğŸ’¡ PEPPERç³»ç»Ÿå†…å­˜ä¼˜åŒ–å»ºè®®

ğŸ¯ è®­ç»ƒæœŸé—´ï¼š
â€¢ å¯ç”¨è‡ªåŠ¨æ¸…ç†åŠŸèƒ½ï¼ˆæ¨èï¼‰
â€¢ ä½¿ç”¨4bité‡åŒ–å‡å°‘å†…å­˜å ç”¨
â€¢ é€‚å½“é™ä½batch_size
â€¢ å…³é—­ä¸å¿…è¦çš„æµè§ˆå™¨æ ‡ç­¾é¡µ

ğŸ”§ æ¨ç†æœŸé—´ï¼š
â€¢ ä»…åŠ è½½æ¨ç†æ¨¡å‹
â€¢ å®šæœŸæ‰‹åŠ¨æ¸…ç†GPUç¼“å­˜
â€¢ ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

âš ï¸ å†…å­˜ä¸è¶³æ—¶ï¼š
â€¢ ç«‹å³æ‰§è¡Œæ‰‹åŠ¨æ¸…ç†
â€¢ é‡å¯ç³»ç»Ÿé‡Šæ”¾æ‰€æœ‰å†…å­˜
â€¢ è€ƒè™‘å‡çº§ç¡¬ä»¶é…ç½®

ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨GPUè¿›è¡Œè®­ç»ƒå’Œæ¨ç†
â€¢ åˆç†é…ç½®é‡åŒ–å‚æ•°
â€¢ é¿å…åŒæ—¶è¿è¡Œå¤šä¸ªæ¨¡å‹
            `;

            alert(tips);
            logMessage('info', 'å·²æ˜¾ç¤ºå†…å­˜ä¼˜åŒ–å»ºè®®');
        }

        // ======================== è®­ç»ƒç›‘æ§åŠŸèƒ½ ========================

        // æ£€æŸ¥è®­ç»ƒçŠ¶æ€
        async function checkTrainingStatus() {
            try {
                const result = await callAPI('training_progress');

                if (result.status === 'success') {
                    updateTrainingDisplay(result);
                    logMessage('info', `è®­ç»ƒçŠ¶æ€æ£€æŸ¥å®Œæˆ: ${result.progress}%`);
                } else {
                    logMessage('error', `æ£€æŸ¥è®­ç»ƒçŠ¶æ€å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                logMessage('error', `æ£€æŸ¥è®­ç»ƒçŠ¶æ€å‡ºé”™: ${error.message}`);
            }
        }

        // æ›´æ–°è®­ç»ƒæ˜¾ç¤º
        function updateTrainingDisplay(progressData) {
            const progress = progressData.progress;
            const active = progressData.active;

            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById('training-progress').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `${progress}%`;

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const statusIndicator = document.getElementById('training-status-indicator');
            if (active) {
                statusIndicator.textContent = 'â— è®­ç»ƒè¿›è¡Œä¸­';
                statusIndicator.className = 'status-indicator status-online';
            } else if (progress >= 100) {
                statusIndicator.textContent = 'â— è®­ç»ƒå·²å®Œæˆ';
                statusIndicator.className = 'status-indicator status-online';
            } else {
                statusIndicator.textContent = 'â— æœªå¼€å§‹è®­ç»ƒ';
                statusIndicator.className = 'status-indicator status-offline';
            }

            // æ›´æ–°è¯¦ç»†ä¿¡æ¯
            const infoDiv = document.getElementById('training-info');
            if (active || progress > 0) {
                infoDiv.style.display = 'block';

                if (progressData.config) {
                    document.getElementById('training-model-path').textContent =
                        progressData.config.model_path || '-';
                    document.getElementById('training-quantization').textContent =
                        progressData.config.quantization || '-';
                }

                if (progressData.estimated_remaining_seconds) {
                    const remainingMinutes = Math.ceil(progressData.estimated_remaining_seconds / 60);
                    document.getElementById('training-remaining').textContent = `${remainingMinutes}åˆ†é’Ÿ`;
                } else {
                    document.getElementById('training-remaining').textContent = '-';
                }

                document.getElementById('training-auto-cleanup').textContent =
                    progressData.auto_cleanup_enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
            } else {
                infoDiv.style.display = 'none';
            }

            // æ›´æ–°æ—¶é—´ä¿¡æ¯
            if (progressData.start_time) {
                const startTime = new Date(progressData.start_time).toLocaleTimeString();
                document.getElementById('progress-time').textContent = `å¼€å§‹: ${startTime}`;
            }

            // æ›´æ–°å†…å­˜ç›‘æ§ï¼ˆå¦‚æœæœ‰ï¼‰
            if (progressData.memory_info) {
                const memInfo = progressData.memory_info;
                const gpuUsage = memInfo.gpu_cached_gb / memInfo.gpu_total_gb * 100;
                document.getElementById('training-gpu-usage').textContent = `${gpuUsage.toFixed(1)}%`;
            }

            // å¦‚æœè®­ç»ƒå®Œæˆï¼Œæ˜¾ç¤ºå®Œæˆä¿¡æ¯
            if (progress >= 100 && !active) {
                setTimeout(() => {
                    if (progressData.auto_cleanup_enabled) {
                        logMessage('success', 'è®­ç»ƒå®Œæˆï¼Œæ¨¡å‹å·²è‡ªåŠ¨æ¸…ç†');
                        alert('ğŸ‰ è®­ç»ƒå®Œæˆï¼\n\nâœ… è®­ç»ƒæ¨¡å‹å·²è‡ªåŠ¨æ¸…ç†ï¼Œå†…å­˜å·²é‡Šæ”¾\nğŸ’¡ ç°åœ¨å¯ä»¥åŠ è½½æ¨ç†æ¨¡å‹è¿›è¡Œæµ‹è¯•');
                    } else {
                        logMessage('success', 'è®­ç»ƒå®Œæˆ');
                        alert('ğŸ‰ è®­ç»ƒå®Œæˆï¼\n\nâš ï¸ è‡ªåŠ¨æ¸…ç†å·²ç¦ç”¨ï¼Œå»ºè®®æ‰‹åŠ¨æ¸…ç†è®­ç»ƒæ¨¡å‹');
                    }
                    refreshMemoryInfo();
                }, 1000);
            }
        }

        // å¼€å§‹è®­ç»ƒç›‘æ§
        function startTrainingMonitoring() {
            if (trainingMonitorInterval) {
                clearInterval(trainingMonitorInterval);
            }

            trainingMonitorInterval = setInterval(() => {
                checkTrainingStatus();
            }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡

            logMessage('info', 'è®­ç»ƒç›‘æ§å·²å¯åŠ¨');
        }

        // åœæ­¢è®­ç»ƒç›‘æ§
        function stopTrainingMonitoring() {
            if (trainingMonitorInterval) {
                clearInterval(trainingMonitorInterval);
                trainingMonitorInterval = null;
                logMessage('info', 'è®­ç»ƒç›‘æ§å·²åœæ­¢');
            }
        }

        // ======================== æ¨ç†æ¨¡å‹åŠŸèƒ½ ========================

        // åŠ è½½æ¨ç†æ¨¡å‹
        async function loadInferenceModel() {
            const modelPath = prompt('è¯·è¾“å…¥æ¨¡å‹è·¯å¾„:', 'models/deepseek-coder-1.3b-base');

            if (!modelPath) return;

            try {
                logMessage('info', `æ­£åœ¨åŠ è½½æ¨ç†æ¨¡å‹: ${modelPath}`);

                const loadBtn = document.getElementById('load-inference-btn');
                loadBtn.textContent = 'ğŸ“¥ åŠ è½½ä¸­...';
                loadBtn.disabled = true;

                const result = await callAPI('load_model', 'POST', {
                    model_path: modelPath,
                    use_4bit: true,
                    use_8bit: false
                });

                if (result.status === 'success') {
                    const quantization = result.quantization || 'unknown';
                    document.getElementById('inference-model-status').textContent = `â— æ¨¡å‹å·²åŠ è½½ (${quantization})`;
                    document.getElementById('inference-model-status').className = 'status-indicator status-online';

                    loadBtn.textContent = `âœ… å·²åŠ è½½ (${quantization})`;
                    loadBtn.style.background = 'linear-gradient(135deg, #2ed573, #17d0aa)';

                    logMessage('success', `æ¨ç†æ¨¡å‹åŠ è½½æˆåŠŸ: ${quantization}é‡åŒ–`);
                    refreshMemoryInfo();
                } else {
                    logMessage('error', `æ¨ç†æ¨¡å‹åŠ è½½å¤±è´¥: ${result.message}`);
                    alert(`æ¨ç†æ¨¡å‹åŠ è½½å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                logMessage('error', `æ¨ç†æ¨¡å‹åŠ è½½å‡ºé”™: ${error.message}`);
                alert(`æ¨ç†æ¨¡å‹åŠ è½½å‡ºé”™: ${error.message}`);
            } finally {
                const loadBtn = document.getElementById('load-inference-btn');
                loadBtn.disabled = false;
                if (loadBtn.textContent === 'ğŸ“¥ åŠ è½½ä¸­...') {
                    loadBtn.textContent = 'ğŸ“¥ åŠ è½½æ¨ç†æ¨¡å‹';
                    loadBtn.style.background = '';
                }
            }
        }

        // å¸è½½æ¨ç†æ¨¡å‹
        async function unloadInferenceModel() {
            try {
                logMessage('info', 'æ­£åœ¨å¸è½½æ¨ç†æ¨¡å‹...');

                const result = await callAPI('unload_model', 'POST');

                if (result.status === 'success') {
                    document.getElementById('inference-model-status').textContent = 'â— æ¨¡å‹æœªåŠ è½½';
                    document.getElementById('inference-model-status').className = 'status-indicator status-offline';

                    const loadBtn = document.getElementById('load-inference-btn');
                    loadBtn.textContent = 'ğŸ“¥ åŠ è½½æ¨ç†æ¨¡å‹';
                    loadBtn.style.background = '';

                    logMessage('success', 'æ¨ç†æ¨¡å‹å·²å¸è½½');
                    refreshMemoryInfo();
                } else {
                    logMessage('error', `æ¨ç†æ¨¡å‹å¸è½½å¤±è´¥: ${result.message}`);
                    alert(`æ¨ç†æ¨¡å‹å¸è½½å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                logMessage('error', `æ¨ç†æ¨¡å‹å¸è½½å‡ºé”™: ${error.message}`);
                alert(`æ¨ç†æ¨¡å‹å¸è½½å‡ºé”™: ${error.message}`);
            }
        }

        // æµ‹è¯•æ¨¡å‹
        async function testModel() {
            const question = document.getElementById('test-question').value.trim();

            if (!question) {
                alert('è¯·è¾“å…¥æµ‹è¯•é—®é¢˜');
                return;
            }

            try {
                logMessage('info', 'æ­£åœ¨æµ‹è¯•æ¨¡å‹...');

                document.getElementById('model-response').textContent = 'ğŸ¤” æ€è€ƒä¸­...';

                const result = await callAPI('test_model', 'POST', {
                    question: question,
                    temperature: 0.7,
                    max_tokens: 512
                });

                if (result.status === 'success') {
                    document.getElementById('model-response').textContent = result.response;
                    logMessage('success', 'æ¨¡å‹æµ‹è¯•å®Œæˆ');
                } else {
                    document.getElementById('model-response').textContent = `âŒ æµ‹è¯•å¤±è´¥: ${result.message}`;
                    logMessage('error', `æ¨¡å‹æµ‹è¯•å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                document.getElementById('model-response').textContent = `âŒ æµ‹è¯•å‡ºé”™: ${error.message}`;
                logMessage('error', `æ¨¡å‹æµ‹è¯•å‡ºé”™: ${error.message}`);
            }
        }

        // ======================== åˆå§‹åŒ– ========================

        // é¡µé¢åŠ è½½å®Œæˆåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('info', 'PEPPERæ™ºèƒ½æ•™å­¦ç³»ç»Ÿå†…å­˜ç®¡ç†ç‰ˆæœ¬åŠ è½½å®Œæˆ');

            // åˆå§‹åŒ–å†…å­˜ç›‘æ§
            refreshMemoryInfo();
            startMemoryMonitoring();

            // æ£€æŸ¥è®­ç»ƒçŠ¶æ€
            checkTrainingStatus();

            // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡è®­ç»ƒçŠ¶æ€
            setInterval(checkTrainingStatus, 30000);

            logMessage('info', 'ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå†…å­˜ç›‘æ§å·²å¯åŠ¨');
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            stopMemoryMonitoring();
            stopTrainingMonitoring();
        });
    </script>
</body>
</html>